<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุฒูุฏฺฏ ุงุฑุงู - ุดุจูโุณุงุฒ ุฒูุฏฺฏ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://v1.fontapi.ir/css/Vazir" rel="stylesheet">\
  <!-- Chart.js CDN updated to a specific stable version (CDN ฺุงุฑุช.ุฌโุงุณ ุจู ูุณุฎู ูพุงุฏุงุฑ ู ูุดุฎุต ุชุบุฑ ุงูุช) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
  <style>
    /* Ensure html and body take full height and do not scroll (ุงุทููุงู ุงุฒ ุงุดุบุงู ฺฉุงูู ุงุฑุชูุงุน ู ุนุฏู ุงุณฺฉุฑูู ุจุฑุง html ู body) */
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden; /* ุฌููฺฏุฑ ุงุฒ ุงุณฺฉุฑูู ฺฉู ุตูุญู */
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Vazir', sans-serif;
      background: linear-gradient(135deg, #121212 0%, #1a202c 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      min-width: 100vw;
      width: 100vw;
      height: 100vh;
      overflow-x: hidden;
      color: white;
}
    /* New game container for scaling the entire game (ฺฉุงูุชูุฑ ุฌุฏุฏ ุจุงุฒ ุจุฑุง ููุงุณโุจูุฏ ฺฉู ุจุงุฒ) */
    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      min-width: 0;
      min-height: 0;
      max-width: 100vw;
      max-height: 100vh;
      overflow: hidden;
      background: linear-gradient(135deg, #121212 0%, #1a202c 100%);
      box-shadow: none;
      border-radius: 0;
      transform: none;
      display: flex;
      flex-direction: column;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: #10b981;
      color: white;
      transition: transform 0.2s ease, background 0.2s ease;
    }
    .btn-primary:hover {
      background: #059669;
      transform: scale(1.05);
    }
    .btn-secondary {
      background: #4b5563;
      color: white;
      transition: transform 0.2s ease, background 0.2s ease;
    }
    .btn-secondary:hover {
      background: #374151;
      transform: scale(1.05);
    }
    .status-bar {
      height: 100%; /* ุงุฑุชูุงุน ููุงุฑ ุฑูฺฏ ุจุฑุงุจุฑ ุจุง ุงุฑุชูุงุน ูุงูุฏุด ุจุงุดุฏ */
      border-radius: 8px; /* ุดุนุงุน ูุฑุฒ ุจุฑุง ููุงุฑ ุฑูฺฏ */
      transition: width 0.3s ease;
    }
    .animate-slide-in {
      animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .money-display {
      font-size: 1.5rem;
      font-weight: bold;
    }

    /* Dashboard specific styling (ุงุณุชุงูโูุง ุฎุงุต ุฏุงุดุจูุฑุฏ) */
    #dashboard {
      display: flex;
      flex-direction: column;
      height: 100%; /* ุงฺฉููู ฑฐฐูช ุงุฒ game-container ุฑุง ุงุดุบุงู ูโฺฉูุฏ */
      /* overflow: hidden ุงุฒ ุงูุฌุง ุญุฐู ุดุฏุ game-container ุขู ุฑุง ูุฏุฑุช ูโฺฉูุฏ */
    }

    /* Header Section (ุจุฎุด ูุฏุฑ) */
    .header-section {
      height: 7rem; /* ุงุฑุชูุงุน ุจู ทrem ุจุงุฒฺฏุฑุฏุงูุฏู ุดุฏ ุชุง ูุถุง ฺฉุงู ุชุถูู ุดูุฏ */
      flex-shrink: 0; /* ุฌููฺฏุฑ ุงุฒ ฺฉูฺฺฉ ุดุฏู */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* ุงูุฒูุฏู ุณุงู ุจุฑุง ุฌุฏุงุณุงุฒ */
      z-index: 10; /* ุงุทููุงู ุงุฒ ูุฑุงุฑฺฏุฑ ูุฏุฑ ุจุงูุง ูุญุชูุง ุงุณฺฉุฑูู */
      display: flex; /* Make it a flex container */
      flex-direction: column; /* Stack children vertically */
      padding: 0.5rem 1rem; /* Added padding to the header section itself (ูพุฏูฺฏ ุจู ุฎูุฏ ูุฏุฑ ุงุถุงูู ุดุฏ) */
    }

    /* Header Top Row (ุดุงูู ุนููุงู ู ุฏฺฉูู ุชูุธูุงุช) */
    .header-top-row {
      display: flex;
      justify-content: center; /* ูุฑฺฉุฒ ฺฉุฑุฏู ุนููุงู */
      align-items: center;
      width: 100%;
      position: relative; /* ุจุฑุง ูููุนุชโุฏู ูุทูู ุฏฺฉูู ุชูุธูุงุช */
      flex-shrink: 0; /* ุฌููฺฏุฑ ุงุฒ ฺฉูฺฺฉ ุดุฏู */
    }

    .header-top-row h1 {
      margin: 0; /* ุญุฐู ูุงุฑุฌูโูุง ุงุถุงู ุงุฒ ุนููุงู */
    }

    .header-top-row #header-settings-btn {
      position: absolute;
      left: 0; /* ูุฑุงุฑ ุฏุงุฏู ุฏฺฉูู ุฏุฑ ุณูุช ฺูพ */
      top: 50%; /* ูุณุท ูุฑุงุฑ ุฏุงุฏู ุนููุฏ */
      transform: translateY(-50%); /* ุชูุธู ุฏูู ุจุฑุง ูุณุท ูุฑุงุฑ ฺฏุฑูุชู ุนููุฏ */
    }

    /* Character Info Row (ุดุงูู ูุงูุ ุณูุ ูพูู ู ุดุบู) */
    .header-info-row {
        display: flex;
        justify-content: space-between; /* ูพุฎุด ฺฉุฑุฏู ุขุชูโูุง ุฏุฑ ุทูู ุฎุท */
        width: 100%;
        margin-top: auto; /* ุจุฑุง ูู ุฏุงุฏู ุงู ุฑุฏู ุจู ูพุงู ูุฏุฑ */
    }

    .header-info-row .flex-1 {
        padding: 0 0.5rem; /* ฺฉุงูุด ูพุฏูฺฏ ุฏุงุฎู ุจุฑุง ุงู ุฏู ุณุชูู */
    }

    /* Main Content Area - This will contain the scrollable life log (ุงู ุจุฎุด ุงุตู ูุญุชูุง ุงุณุช ฺฉู ุดุงูู ฺฏุฒุงุฑุด ุฒูุฏฺฏ ูุงุจู ุงุณฺฉุฑูู ุฎูุงูุฏ ุจูุฏ) */
    #main-dashboard-content {
      flex-grow: 1; /* ูุถุง ุนููุฏ ุจุงูโูุงูุฏู ุฑุง ุงุดุบุงู ูโฺฉูุฏ */
      padding: 0.5rem; /* ฺฉุงูุด ูพุฏูฺฏ ฺฉู ุจุฑุง ูุถุง ุฏุงุฎู */
      display: flex; /* ุขู ุฑุง ุจู ฺฉุงูุชูุฑ ููฺฉุณ ุชุจุฏู ฺฉูุฏ */
      flex-direction: column; /* ูุฑุฒูุฏุงู ุฑุง ุจู ุตูุฑุช ุนููุฏ ูพุดุชู ฺฉูุฏ */
      justify-content: flex-start; /* ูุญุชูุง ุฑุง ุฏุฑ ุจุงูุง ุงู ูุงุญู ููุชุฑุงุฒ ฺฉูุฏ */
      align-items: center; /* ูุญุชูุง ุฑุง ุจู ุตูุฑุช ุงูู ูุณุท ูุฑุงุฑ ุฏูุฏ */
      overflow-y: auto; /* ุงู ุจุฎุด ุงุตู ุงฺฉููู ุงุณฺฉุฑูู ุฎูุฏุด ุฑุง ูุฏุฑุช ุฎูุงูุฏ ฺฉุฑุฏ */
      -webkit-overflow-scrolling: touch; /* ุงุณฺฉุฑูู ุฑูุงู ุฏุฑ iOS */
    }
    
    /* Styles for the glass-card containing life-log (ุงุณุชุงูโูุง ุจุฑุง glass-card ุดุงูู ฺฏุฒุงุฑุด ุฒูุฏฺฏ) */
    #life-log-scroll-container { /* New ID for direct targeting (ุขโุฏ ุฌุฏุฏ ุจุฑุง ูุฏูโฺฏุฑ ูุณุชูู) */
      width: 100%; /* ุงุทููุงู ุงุฒ ูพุฑ ฺฉุฑุฏู ุนุฑุถ */
      max-width: 768px; /* ุงุฎุชุงุฑ: ูุญุฏูุฏ ฺฉุฑุฏู ุญุฏุงฺฉุซุฑ ุนุฑุถ ุจุฑุง ุฎูุงูุง ุจูุชุฑ ุฏุฑ ุตูุญุงุช ุจุฒุฑฺฏุชุฑ */
      /* ุงุฑุชูุงุน ุชูุณุท ูุญุชูุง ุฏุงุฎู ุขู ู overflow-y ุฏุฑ ูุงูุฏ ูุฏุฑุช ูโุดูุฏ */
    }

    /* Styles for the actual life-log content area (ุงุณุชุงูโูุง ุจุฑุง ูุงุญู ูุญุชูุง ฺฏุฒุงุฑุด ุฒูุฏฺฏ ูุงูุน) */
    #life-log {
      space-y: 4; /* ูุงุตูู ุฑุง ุญูุธ ฺฉูุฏ */
    }

    /* Bottom Sections - Now part of flex flow (ุจุฎุดโูุง ูพุงู - ุงฺฉููู ุจุฎุด ุงุฒ ุฌุฑุงู ููฺฉุณ) */
    .status-bars-section {
      height: 180px; /* ุงุฑุชูุงุน ุตุฑุญ ุชูุธู ุดุฏู ุงุณุช */
      flex-shrink: 0; /* ุฌููฺฏุฑ ุงุฒ ฺฉูฺฺฉ ุดุฏู */
      padding: 0.5rem 1rem; /* ฺฉุงูุด ูพุฏูฺฏ ุนููุฏ ุจุฑุง ูุถุง ุจุดุชุฑ */
      background: rgba(255, 255, 255, 0.08); /* ูพุณโุฒููู glass-card */
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1); /* ุญุงุดู ุจุงูุง ุจุฑุง ุฌุฏุงุณุงุฒ */
      border-radius: 12px 12px 0 0; /* ฺฏูุดูโูุง ุจุงูุง ฺฏุฑุฏ */
      z-index: 10; /* ุงุทููุงู ุงุฒ ูุฑุงุฑฺฏุฑ ููุงุฑูุง ูุถุนุช ุจุงูุง ูุญุชูุง ุงุณฺฉุฑูู */
    }
    .status-bars-section .flex-col {
        space-y: 1; /* ฺฉุงูุด ูุงุตูู ุจู ุขุชูโูุง ููุงุฑ ูุถุนุช */
    }
    .status-bars-section .flex-shrink-0.w-24 { /* Adjust width for labels */
        width: 5rem; /* w-20 = 80px */
    }
    .status-bars-section .font-bold.text-sm.w-12 { /* Adjust width for values */
        width: 2.5rem; /* w-10 = 40px */
    }

    /* Header specific text overflow handling (ูุฏุฑุช ุณุฑุฑุฒ ูุชู ุฎุงุต ูุฏุฑ) */
    #dashboard-char-name,
    #dashboard-char-age,
    #dashboard-char-money,
    #dashboard-char-job {
      white-space: nowrap; /* ุฌููฺฏุฑ ุงุฒ ุดฺฉุณุชู ุฎุท ูุชู */
      overflow: hidden;     /* ูพููุงู ฺฉุฑุฏู ูุญุชูุง ุงุถุงู */
      text-overflow: ellipsis; /* ููุงุด ุณู ููุทู (...) ุจุฑุง ูุชูโูุง ุจุฑุฏู ุดุฏู */
    }


    .tab-bar {
      height: 60px; /* ุงุฑุชูุงุน ุตุฑุญ ุชูุธู ุดุฏู ุงุณุช */
      flex-shrink: 0; /* ุฌููฺฏุฑ ุงุฒ ฺฉูฺฺฉ ุดุฏู */
      padding: 0.5rem; /* py-2 */
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px 12px 0 0; /* ฺฏูุดูโูุง ุจุงูุง ฺฏุฑุฏ */
      z-index: 10; /* ุงุทููุงู ุงุฒ ูุฑุงุฑฺฏุฑ ููุงุฑ ุชุจ ุจุงูุง ูุญุชูุง ุงุณฺฉุฑูู */
      display: grid; /* ุงุณุชูุงุฏู ุงุฒ ฺฏุฑุฏ ุจุฑุง ฺฉูุชุฑู ุฏููโุชุฑ ุฌุงโฺฏุฑ ุฏฺฉููโูุง */
      grid-template-columns: repeat(5, 1fr); /* ุชูุณู ุจู 5 ุณุชูู ูุณุงู */
      gap: 0.2rem; /* ูุงุตูู ฺฉู ุจู ุฏฺฉููโูุง */
      justify-items: center; /* ูุณุท ูุฑุงุฑ ุฏุงุฏู ุขุชูโูุง ุฏุฑ ุณุชููโูุง ฺฏุฑุฏ */
      align-items: center; /* ูุณุท ูุฑุงุฑ ุฏุงุฏู ุขุชูโูุง ุจู ุตูุฑุช ุนููุฏ */
    }
    /* Styling for tab bar buttons (ุงุณุชุงูโุฏู ุจุฑุง ุฏฺฉููโูุง ููุงุฑ ุชุจ) */
    .tab-bar button {
      display: flex; /* ุฏฺฉููโูุง ุจู ุตูุฑุช ููฺฉุณ ููุงุด ุฏุงุฏู ุดููุฏ */
      flex-direction: column; /* ูุญุชูุงุช ุฏฺฉูู (ุงููุฌ ู ูุชู) ุจู ุตูุฑุช ุนููุฏ ฺุฏู ุดููุฏ */
      align-items: center; /* ูุญุชูุงุช ุฏฺฉูู ุฏุฑ ูุฑฺฉุฒ ูุฑุงุฑ ฺฏุฑูุฏ */
      padding: 0.3rem; /* ูพุฏูฺฏ ุฏฺฉููโูุง ฺฉุงูุด ุงูุช */
      border-radius: 0.5rem;
      transition: background 0.2s ease;
      width: 100%; /* ุงุทููุงู ุงุฒ ูพุฑ ฺฉุฑุฏู ุนุฑุถ ุณุชูู ฺฏุฑุฏ */
    }
    .tab-bar button span:first-child { /* ุงููุฌ ุฏฺฉููโูุง */
      font-size: 1.3rem; /* ุงูุฏุงุฒู ุงููุฌ ุจุฑุง ููุงุฑ ุชุจ ุงูุฒุงุด ุงูุช */
      line-height: 1; /* ุชูุธู ุงุฑุชูุงุน ุฎุท ุจุฑุง ุชุฑุงุฒ ุจูุชุฑ */
      margin-bottom: 0.1rem; /* ูุงุตูู ุจุณุงุฑ ฺฉู ุจู ุงููุฌ ู ูุชู */
    }
    .tab-bar button span:last-child {
      font-weight: 700; /* ูุชู ุจููุฏ */
      font-size: 0.75rem; /* ุงูุฏุงุฒู ูููุช ูุชู ููุงุฑ ุชุจ ฺฉู ุงูุฒุงุด ุงูุช */
      white-space: nowrap; /* ุฌููฺฏุฑ ุงุฒ ุดฺฉุณุชู ุฎุท ูุชู */
      overflow: hidden; /* ูพููุงู ฺฉุฑุฏู ูุฑ ูุชู ฺฉู ุงุฒ ฺฉุงุฏุฑ ุจุฑูู ูโุฒูุฏ */
      text-overflow: ellipsis; /* ููุงุด ุณู ููุทู ุจุฑุง ูุชูโูุง ุจุฑุฏู ุดุฏู */
    }

    .modal-overlay {
      position: fixed; /* ุจุงุฏ ูุณุจุช ุจู viewport ุซุงุจุช ุจูุงูุฏ */
      inset: 0;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-content {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }
    .modal-button-container {
      display: flex;
      justify-content: space-around;
      margin-top: 1rem;
    }
    .modal-button {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .modal-button.primary {
      background-color: #10b981;
      color: white;
    }
    .modal-button.primary:hover {
      background: #059669;
      transform: translateY(-2px);
    }
    .modal-button.secondary {
      background-color: #4b5563;
      color: white;
    }
    .modal-button.secondary:hover {
      background-color: #374151;
      transform: translateY(-2px);
    }
    /* Ensure scrollability for content within pages (ุงุทููุงู ุงุฒ ูุงุจูุช ุงุณฺฉุฑูู ุจุฑุง ูุญุชูุง ุฏุฑูู ุตูุญุงุช) */
    .page-content-scroll {
      display: flex; /* ุงฺฉููู ุงููุง ูุฒ ููฺฉุณ ฺฉุงูุชูุฑ ูุณุชูุฏ */
      flex-direction: column;
      height: 100%; /* ฑฐฐูช ุงุฑุชูุงุน ฺฉุงูุชูุฑ ูุงูุฏ ุฎูุฏ (game-container) ุฑุง ุงุดุบุงู ูโฺฉููุฏ */
      overflow-y: auto; /* ุงุณฺฉุฑูู ุฏุงุฎู ุจุฑุง ูุญุชูุง */
      -webkit-overflow-scrolling: touch; /* ุงุณฺฉุฑูู ุฑูุงู ุฏุฑ iOS */
      padding: 0.5rem; /* ฺฉุงูุด ูพุฏูฺฏ ุจุฑุง ูุถุง ุจุดุชุฑ ูุญุชูุง */
      padding-bottom: 1rem; /* ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุจุฑุฏู ุดุฏู ูุญุชูุง ุฏุฑ ูพุงู */
    }
    .back-button-container {
        display: flex;
        justify-content: flex-start; /* ููุชุฑุงุฒ ฺฉุฑุฏู ุจู ฺูพ */
        margin-bottom: 0.5rem; /* ูุถุง ุฒุฑ ุฏฺฉูู ฺฉุงูุด ุงูุช */
        flex-shrink: 0; /* ุงุฒ ฺฉูฺฺฉ ุดุฏู ุฏฺฉูู ุจุงุฒฺฏุดุช ุฌููฺฏุฑ ูโฺฉูุฏ */
    }
    /* Styling for activity menu buttons - Adjusted emoji size and made text bold (ุงุณุชุงูโุฏู ุจุฑุง ุฏฺฉููโูุง ููู ูุนุงูุช - ุชูุธู ุงูุฏุงุฒู ุงููุฌ ู ุจููุฏ ฺฉุฑุฏู ูุชู) */
    #activities-menu .glass-card span:first-child {
      font-size: 2.2rem; /* ุงูุฏุงุฒู ุงููุฌ ฺฉู ฺฉูฺุชุฑ ุจุฑุง ููู ูุนุงูุชโูุง */
      line-height: 1;
      margin-bottom: 0.5rem; /* ุงูุฒูุฏู ููุฏุงุฑ ูุงุตูู ุฒุฑ ุงููุฌ */
    }
    #activities-menu .glass-card span:last-child {
      font-weight: 700; /* ูุชู ุจููุฏ */
    }


    /* Hide scrollbar for WebKit browsers (Chrome, Safari) - ูพููุงู ฺฉุฑุฏู ุงุณฺฉุฑููโุจุงุฑ ุจุฑุง ูุฑูุฑฺฏุฑูุง WebKit */
    #main-dashboard-content::-webkit-scrollbar, 
    .page-content-scroll::-webkit-scrollbar,
    #life-log-full::-webkit-scrollbar,
    #life-log-scroll-container::-webkit-scrollbar, /* ฺฉุงูุชูุฑ ุงุณฺฉุฑูู ุฌุฏุฏ ุฏุงุดุจูุฑุฏ ุฑุง ูุฏู ูุฑุงุฑ ุฏูุฏ */
    #full-log-scroll-area::-webkit-scrollbar,
    .asset-list-container::-webkit-scrollbar,
    #career-category-list::-webkit-scrollbar, /* Added for career categories */
    #job-list-container::-webkit-scrollbar, /* Added for job listings */
    #owned-gold_coins-list::-webkit-scrollbar,
    #buy-gold_coins-list::-webkit-scrollbar,
    #owned-stocks_bourse-list::-webkit-scrollbar,
    #buy-stocks_bourse-list::-webkit-scrollbar,
    #owned-cryptocurrency-list::-webkit-scrollbar,
    #buy-cryptocurrency-list::-webkit-scrollbar,
    #owned-investment_land-list::-webkit-scrollbar,
    #buy-investment_land-list::-webkit-scrollbar,
    #owned-raw_materials-list::-webkit-scrollbar,
    #buy-raw_materials-list::-webkit-scrollbar,
    #owned-properties-list::-webkit-scrollbar,
    #buy-properties-list::-webkit-scrollbar,
    #owned-vehicles-list::-webkit-scrollbar,
    #buy-vehicles-list::-webkit-scrollbar,
    #owned-plane_boat-list::-webkit-scrollbar,
    #buy-plane_boat-list::-webkit-scrollbar,
    #owned-jewelry-list::-webkit-scrollbar,
    #buy-jewelry-list::-webkit-scrollbar,
    #owned-instruments-list::-webkit-scrollbar,
    #buy-instruments-list::-webkit-scrollbar,
    #education-content-scroll::-webkit-scrollbar /* Added for new education content scroll */
     {
      display: none;
    }

    /* Hide scrollbar for Firefox - ูพููุงู ฺฉุฑุฏู ุงุณฺฉุฑููโุจุงุฑ ุจุฑุง ูุงุฑูุงฺฉุณ */
    #main-dashboard-content, 
    .page-content-scroll,
    #life-log-full,
    #life-log-scroll-container, /* ฺฉุงูุชูุฑ ุงุณฺฉุฑูู ุฌุฏุฏ ุฏุงุดุจูุฑุฏ ุฑุง ูุฏู ูุฑุงุฑ ุฏูุฏ */
    #full-log-scroll-area,
    .asset-list-container,
    #career-category-list, /* Added for career categories */
    #job-list-container, /* Added for job listings */
    #owned-gold_coins-list,
    #buy-gold_coins-list,
    #owned-stocks_bourse-list,
    #buy-stocks_bourse-list,
    #owned-cryptocurrency-list,
    #buy-cryptocurrency-list,
    #owned-investment_land-list,
    #buy-investment_land-list,
    #owned-raw_materials-list,
    #buy-raw_materials-list,
    #owned-properties-list,
    #buy-properties-list,
    #owned-vehicles-list,
    #buy-vehicles-list,
    #owned-plane_boat-list,
    #buy-plane_boat-list,
    #owned-jewelry-list,
    #buy-jewelry-list,
    #owned-instruments-list,
    #buy-instruments-list,
    #education-content-scroll /* Added for new education content scroll */
    {
      scrollbar-width: none; /* Firefox */
    }

    /* Styling for the new full log page scroll area (ุงุณุชุงูโุฏู ุจุฑุง ูุงุญู ุงุณฺฉุฑูู ุฌุฏุฏ ุตูุญู ฺฏุฒุงุฑุด ฺฉุงูู) */
    #log-page .glass-card { /* ูุงูุฏ #full-log-scroll-area */
        flex-grow: 1; /* ุงู ฺฏูุณ-ฺฉุงุฑุฏ ูุถุง ุจุงูโูุงูุฏู ุฑุง ุงุดุบุงู ูโฺฉูุฏ */
        display: flex; /* ุขู ุฑุง ุจู ฺฉุงูุชูุฑ ููฺฉุณ ุชุจุฏู ฺฉูุฏ */
        flex-direction: column; /* ูุญุชูุงุช ุฏุงุฎู ุฑุง ุจู ุตูุฑุช ุนููุฏ ูพุดุชู ฺฉูุฏ */
        min-height: 0; /* ุจุฑุง ุขุชูโูุง ููฺฉุณ ุจุง overflow ุถุฑูุฑ ุงุณุช */
    }
    #log-page .glass-card > .flex.space-x-2.mb-2 { /* ฺฉุงูุชูุฑ ุฏฺฉููโูุง ููุชุฑ */
        flex-shrink: 0; /* ุงุฒ ฺฉูฺฺฉ ุดุฏู ุฏฺฉููโูุง ุฌููฺฏุฑ ูโฺฉูุฏ */
    }
    #full-log-scroll-area { 
        overflow-y: auto;
        flex-grow: 1; /* ูุถุง ุจุงูโูุงูุฏู ุฑุง ุฏุฑ ูุงูุฏ ููฺฉุณ ุฎูุฏ ุงุดุบุงู ูโฺฉูุฏ */
        min-height: 0; /* ููู ุจุฑุง ุขุชูโูุง ููฺฉุณ ุจุง ูุงุจูุช overflow */
    }
    /* Further reductions for log-page elements */
    #log-page {
        padding: 0.5rem; /* p-2 */
    }
    #log-page h2 {
        margin-bottom: 0.5rem; /* mb-2 */
        flex-shrink: 0; /* ุฌููฺฏุฑ ุงุฒ ฺฉูฺฺฉ ุดุฏู ุนููุงู */
    }
    #log-page .glass-card > .flex.space-x-2.mb-4 { /* Filter buttons container */
        margin-bottom: 0.5rem; /* mb-2 */
    }

    /* Game Over Modal Styling (ุงุณุชุงู ููุฏุงู ูพุงุงู ุจุงุฒ) */
    #game-over-screen {
        background: linear-gradient(135deg, #2b0b0b 0%, #4a1a1a 100%); /* Darker red gradient for game over */
        text-align: center;
        padding: 2rem;
    }
    #game-over-screen h2 {
        font-size: 2.5rem;
        color: #ff6b6b; /* Bright red for "Game Over" */
        margin-bottom: 1rem;
    }
    #game-over-screen p {
        font-size: 1.2rem;
        margin-bottom: 1.5rem;
        color: #ddd;
    }
  </style>
</head>
<body>
  <!-- New: Main game container for scaling -->
  <div id="game-container">
    <div id="start-screen" class="flex flex-col items-center justify-center h-full p-4"> <!-- Changed min-h-screen to h-full -->
      <img src="https://placehold.co/150x120/10b981/ffffff?text=ููฺฏู" alt="ููฺฏู ุจุงุฒ" class="h-32 mb-5 animate-slide-in rounded-lg">
      <div class="glass-card p-6 w-11/12 max-w-md text-center">
        <h1 class="text-3xl font-bold mb-4">ุฒูุฏฺฏ ุงุฑุงู</h1>
        <input id="name-input" type="text" placeholder="ูุงู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ" class="w-full p-3 mb-4 text-right bg-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500" value="ุนุฑูุงู ุฎุณุฑู">
        <select id="gender-select" class="w-full p-3 mb-4 text-right bg-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
          <option value="male" selected>ูุฑุฏ ๐จ</option>
          <option value="female">ุฒู ๐ฉ</option>
        </select>
        <select id="province-select" class="w-full p-3 mb-4 text-right bg-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
          <option value="tehran" selected>ุชูุฑุงู - ูพุงุชุฎุชุ ุงูฺฉุงูุงุช ุฒุงุฏ</option>
          <option value="isfahan">ุงุตููุงู - ุชุงุฑุฎุ ูุฑููฺฏ</option>
          <option value="shiraz">ุดุฑุงุฒ - ุงุฏุจุ ุฎูุด ุขุจโูููุง</option>
          <option value="mashhad">ูุดูุฏ - ูุฐูุจุ ุฒุงุฑุช</option>
          <option value="tabriz">ุชุจุฑุฒ - ุตูุนุชุ ุชุงุฑุฎ</option>
        </select>
        <select id="family-status" class="w-full p-3 mb-4 text-right bg-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
          <option value="normal" selected>ุฎุงููุงุฏู ูุนููู</option>
          <option value="wealthy">ุฎุงููุงุฏู ุซุฑูุชููุฏ</option>
          <option value="rural">ุฎุงููุงุฏู ุฑูุณุชุง</option>
          <option value="poor">ุฎุงููุงุฏู ุจุง ูุดฺฉูุงุช ูุงู</option>
        </select>
        <button id="start-new-life" class="btn-primary w-4/5 py-3 rounded-full text-lg font-semibold mb-3 shadow-lg">ุดุฑูุน ุฒูุฏฺฏ ุฌุฏุฏ</button>
        <button id="continue-life" class="btn-secondary w-4/5 py-3 rounded-full text-md shadow-lg">ุงุฏุงูู ุฒูุฏฺฏ ูุจู</button>
      </div>
      <!-- Removed settings button from start screen (ุฏฺฉูู ุชูุธูุงุช ุงุฒ ุตูุญู ุดุฑูุน ุญุฐู ุดุฏ) -->
      <div class="absolute bottom-5 right-5">
        <select id="language-select" class="bg-gray-800 p-2 rounded-lg text-sm">
          <option value="fa" selected>ูุงุฑุณ</option>
        </select>
      </div>
    </div>

    <div id="dashboard" style="display: none;">
      <!-- Header Section (ุจุฎุด ูุฏุฑ) -->
      <div class="header-section glass-card">
        <div class="header-top-row">
          <button id="header-settings-btn" class="text-gray-400 hover:text-white transition text-2xl p-1 rounded-full hover:bg-gray-700">โ๏ธ</button>
          <h1 class="text-2xl font-bold text-white flex-grow text-center ml-10">ุฒูุฏฺฏ ุงุฑุงู</h1> <!-- Added ml-10 to offset settings button and keep title centered -->
        </div>
        <div class="header-info-row">
          <!-- Left Section: Name & Age (ุจุฎุด ฺูพ: ูุงู ู ุณู) -->
          <div class="text-right flex-1 pr-4">
            <h2 id="dashboard-char-name" class="text-xl font-bold"></h2>
            <p id="dashboard-char-age" class="text-sm text-gray-300"></p>
          </div>

          <!-- Right Section: Money & Job (ุจุฎุด ุฑุงุณุช: ูพูู ู ุดุบู) -->
          <div class="text-left flex-1 pl-4 flex flex-col items-end">
            <p id="dashboard-char-money" class="text-sm text-emerald-400"></p>
            <p id="dashboard-char-job" class="text-xs text-gray-300"></p>
          </div>
        </div>
      </div>

      <!-- Main Content Area - This will be the scrollable part (ุงู ุจุฎุด ุงุตู ูุญุชูุง ุงุณุช ฺฉู ุดุงูู ฺฏุฒุงุฑุด ุฒูุฏฺฏ ูุงุจู ุงุณฺฉุฑูู ุฎูุงูุฏ ุจูุฏ) -->
      <div id="main-dashboard-content"> 
        <div id="life-log-scroll-container" class="glass-card p-4">
          <!-- Removed "ฺฏุฒุงุฑุด ุฒูุฏฺฏ" header as requested (ูุฏุฑ "ฺฏุฒุงุฑุด ุฒูุฏฺฏ" ุทุจู ุฏุฑุฎูุงุณุช ุญุฐู ุดุฏ) -->
          <div id="life-log" class="space-y-4"></div>
        </div>
      </div>

      <!-- Bottom Status Bars & Tab Bar (ููุงุฑูุง ูุถุนุช ู ููุงุฑ ุชุจ ูพุงู) -->
      <!-- Status bars (ููุงุฑูุง ูุถุนุช) -->
      <div id="status-bars-container" class="status-bars-section"> 
        <div class="flex flex-col space-y-1 text-sm"> <!-- space-y-1 ุจุฑุง ฺฉุงูุด ูุงุตูู ุนููุฏ -->
          <!-- Status Bar Item (ุขุชู ููุงุฑ ูุถุนุช) - ูุฑ ุขุชู ููุงุฑ ูุถุนุช ุงฺฉููู ุงุฒ ฺฉ flex container ุจุฑุง ุชูุฒุน ูุถุง ุงุณุชูุงุฏู ูโฺฉูุฏ -->
          <div class="flex items-center justify-between h-8"> <!-- ุงูุฒุงุด ุงุฑุชูุงุน ุจุฑุง ุฌุง ุฏุงุฏู ูุชู ู ููุงุฑ ุฏุฑ ฺฉ ุฎุท -->
            <span class="flex-shrink-0 w-20 text-base">๐ ุดุงุฏ</span> <!-- ุนุฑุถ ุซุงุจุช ุจุฑุง ุงููุฌ ู ูุชู -->
            <div class="flex-grow bg-gray-700 rounded-full h-4 mx-2"> <!-- flex-grow ุจุฑุง ุงุดุบุงู ูุถุง ุจุงูโูุงูุฏู ุชูุณุท ููุงุฑ ุงุตู -->
              <div id="happiness-bar" class="status-bar bg-blue-500"></div>
            </div>
            <span id="happiness-value" class="text-right font-bold text-sm w-10"></span> <!-- ุนุฑุถ ุซุงุจุช ุจุฑุง ุฏุฑุตุฏ ู ุจููุฏ ฺฉุฑุฏู -->
          </div>

          <div class="flex items-center justify-between h-8">
            <span class="flex-shrink-0 w-20 text-base">๐ช ุณูุงูุช</span>
            <div class="flex-grow bg-gray-700 rounded-full h-4 mx-2">
              <div id="health-bar" class="status-bar bg-red-500"></div>
            </div>
            <span id="health-value" class="text-right font-bold text-sm w-10"></span>
          </div>

          <div class="flex items-center justify-between h-8">
            <span class="flex-shrink-0 w-20 text-base">๐ง ููุด</span>
            <div class="flex-grow bg-gray-700 rounded-full h-4 mx-2">
              <div id="smarts-bar" class="status-bar bg-purple-500"></div>
            </div>
            <span id="smarts-value" class="text-right font-bold text-sm w-10"></span>
          </div>

          <div class="flex items-center justify-between h-8">
            <span class="flex-shrink-0 w-20 text-base">๐ ุธุงูุฑ</span>
            <div class="flex-grow bg-gray-700 rounded-full h-4 mx-2">
              <div id="looks-bar" class="status-bar bg-yellow-500"></div>
            </div>
            <span id="looks-value" class="text-right font-bold text-sm w-10"></span>
          </div>

          <div class="flex items-center justify-between h-8">
            <span class="flex-shrink-0 w-20 text-base">๐ ูุนููุช</span>
            <div class="flex-grow bg-gray-700 rounded-full h-4 mx-2">
              <div id="spirituality-bar" class="status-bar bg-teal-500"></div>
            </div>
            <span id="spirituality-value" class="text-right font-bold text-sm w-10"></span>
          </div>
        </div>
      </div>

      <div class="tab-bar"> <!-- ุงุณุชูุงุฏู ุงุฒ ฺฏุฑุฏ ุจุฑุง ุชูุธู ุจูุชุฑ ุฏฺฉููโูุง ููู ุฏุฑ ููุจุงู -->
        <!-- New Tab Buttons (ุฏฺฉููโูุง ุชุจ ุฌุฏุฏ) -->
        <button id="career-tab" class="hover:bg-gray-700 transition"><span>๐ผ</span><span>ุญุฑูู</span></button>
        <button id="assets-tab" class="hover:bg-gray-700 transition"><span>๐ฐ</span><span>ุฏุงุฑุงโูุง</span></button>
        <button id="age-up-tab" class="hover:bg-gray-700 transition"><span>โญ๏ธ</span><span>ฺฉ ุณุงู ุจฺฏุฐุฑูู</span></button>
        <button id="relationships-main-tab" class="hover:bg-gray-700 transition"><span>โค๏ธ</span><span>ุฑูุงุจุท</span></button>
        <button id="activities-tab" class="hover:bg-gray-700 transition"><span>...</span><span>ูุนุงูุชโูุง</span></button>
      </div>

      <div id="activities-menu" style="display: none;" class="modal-overlay"> <!-- Renamed from more-menu -->
        <div class="modal-content text-white">
          <h2 class="text-xl font-bold mb-4">ฺฏุฒููโูุง ุจุดุชุฑ</h2>
          <div class="grid grid-cols-2 gap-4">
            <button id="education-btn" class="glass-card p-4 flex flex-col items-center justify-center hover:bg-gray-700 transition">
              <span class="text-2xl">๐</span>
              <span>ุชุญุตูุงุช</span>
            </button>
            <button id="health-btn" class="glass-card p-4 flex flex-col items-center justify-center hover:bg-gray-700 transition">
              <span class="text-2xl">๐ฅ</span>
              <span>ุณูุงูุช</span>
            </button>
            <button id="investments-btn" class="glass-card p-4 flex flex-col items-center justify-center hover:bg-gray-700 transition">
              <span class="text-2xl">๐</span>
              <span>ุณุฑูุงูโฺฏุฐุงุฑ</span>
            </button>
            <!-- Removed settings button from activities menu (ุฏฺฉูู ุชูุธูุงุช ุงุฒ ููู ูุนุงูุชโูุง ุญุฐู ุดุฏ) -->
          </div>
          <button id="close-activities-menu" class="btn-secondary w-full py-2 mt-4 rounded-lg">ุจุณุชู</button> <!-- Renamed ID -->
        </div>
      </div>
    </div>

    <div id="character-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <!-- Back button for Character Page, returns to Dashboard (ุฏฺฉูู ุจุงุฒฺฏุดุช ุจุฑุง ุตูุญู ุดุฎุตุชุ ุจู ุฏุงุดุจูุฑุฏ ุจุฑูโฺฏุฑุฏุฏ) -->
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('dashboard')">ุจุงุฒฺฏุดุช</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">ุงุทูุงุนุงุช ุดุฎุตุช</h2>
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <p><strong>ูุงู:</strong> <span id="char-name"></span></p>
        <p><strong>ุฌูุณุช:</strong> <span id="char-gender"></span></p>
        <p><strong>ูุญู ุชููุฏ:</strong> <span id="char-province"></span></p>
        <p><strong>ูุถุนุช ุฎุงููุงุฏฺฏ:</strong> <span id="char-family"></span></p>
        <p><strong>ุณู:</strong> <span id="char-age"></span></p>
      </div>
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฎุงููุงุฏู</h3>
        <ul id="family-list" class="space-y-2"></ul>
      </div>
      <div class="glass-card p-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ูฺฺฏโูุง</h3>
        <p>ููุด: <span id="char-smarts"></span></p>
        <p>ุธุงูุฑ: <span id="char-looks"></span></p>
        <p>ูุนููุช: <span id="char-spirituality"></span></p>
      </div>
    </div>

    <div id="log-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <!-- Back button for Log Page, returns to Activities Menu (ุฏฺฉูู ุจุงุฒฺฏุดุช ุจุฑุง ุตูุญู ุชุงุฑุฎฺูุ ุจู ููู ูุนุงูุชโูุง ุจุฑูโฺฏุฑุฏุฏ) -->
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('dashboard'); window.showActivitiesMenu();">ุจุงุฒฺฏุดุช</button>
      </div>
      <h2 class="text-2xl font-bold mb-2 flex-shrink-0">ุชุงุฑุฎฺู ุฒูุฏฺฏ</h2> <!-- Margin bottom reduced here -->
      <div class="glass-card p-4 flex flex-col flex-grow"> <!-- Added flex flex-col and flex-grow to parent glass-card -->
        <div class="flex space-x-2 mb-2 overflow-x-auto pb-2 flex-shrink-0"> <!-- Margin bottom reduced here -->
          <button id="log-filter-all" class="btn-primary px-4 py-2 rounded-lg flex-shrink-0">ููู</button>
          <button id="log-filter-career" class="btn-secondary px-4 py-2 rounded-lg flex-shrink-0">ุดุบู</button>
          <button id="log-filter-family" class="btn-secondary px-4 py-2 rounded-lg flex-shrink-0">ุฎุงููุงุฏู</button>
          <button id="log-filter-health" class="btn-secondary px-4 py-2 rounded-lg flex-shrink-0">ุณูุงูุช</button>
          <button id="log-filter-education" class="btn-secondary px-4 py-2 rounded-lg flex-shrink-0">ุชุญุตูุงุช</button>
        </div>
        <div id="full-log-scroll-area"> <!-- New scrollable container for the full log (ฺฉุงูุชูุฑ ูุงุจู ุงุณฺฉุฑูู ุฌุฏุฏ ุจุฑุง ฺฏุฒุงุฑุด ฺฉุงูู) -->
          <ul id="life-log-full" class="space-y-4"></ul>
        </div>
      </div>
    </div>

    <div id="education-page" style="display: none;" class="h-full page-content-scroll"> 
      <div class="back-button-container">
          <!-- Back button for Education Page, returns to Activities Menu -->
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('dashboard'); window.showActivitiesMenu();">ุจุงุฒฺฏุดุช</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">ุชุญุตูุงุช</h2>
      <div class="glass-card p-4 flex flex-col flex-grow"> 
        <div class="flex space-x-2 mb-4 flex-shrink-0">
          <button id="school-tab" class="btn-primary px-4 py-2 rounded-lg" onclick="window.showSchool()">ูุฏุฑุณู</button>
          <button id="university-tab" class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showUniversity()">ุฏุงูุดฺฏุงู</button>
        </div>
        <div id="education-content-scroll" class="flex-grow overflow-y-auto"> <!-- Added scrollable container -->
          <!-- Education content will be dynamically loaded here -->
        </div>
      </div>
    </div>

    <div id="relationships-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <!-- Back button for Relationships Page, returns to Dashboard (ุฏฺฉูู ุจุงุฒฺฏุดุช ุจุฑุง ุตูุญู ุฑูุงุจุทุ ุจู ุฏุงุดุจูุฑุฏ ุจุฑูโฺฏุฑุฏุฏ) -->
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('dashboard')">ุจุงุฒฺฏุดุช</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">ุฑูุงุจุท</h2>
      <div id="relationships-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-shrink-0"></div>
      <div class="glass-card p-4 mt-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฑูุงุจุท ุนุงุทู</h3>
        <div id="romantic-relationships" class="space-y-2"></div>
        <button id="find-partner-btn" class="btn-primary px-4 py-2 rounded-lg mt-4">ูพุฏุง ฺฉุฑุฏู ุดุฑฺฉ ุนุงุทู</button>
      </div>
    </div>

    <div id="health-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <!-- Back button for Health Page, returns to Activities Menu (ุฏฺฉูู ุจุงุฒฺฏุดุช ุจุฑุง ุตูุญู ุณูุงูุชุ ุจู ููู ูุนุงูุชโูุง ุจุฑูโฺฏุฑุฏุฏ) -->
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('dashboard'); window.showActivitiesMenu();">ุจุงุฒฺฏุดุช</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">ุณูุงูุช</h2>
      <div class="glass-card p-4 flex-shrink-0">
        <p><strong>ูุถุนุช ุณูุงูุช:</strong> <span id="health-status"></span></p>
        <p><strong>ุจูุงุฑโูุง:</strong> <span id="illnesses"></span></p>
        <div class="flex space-x-2 mt-4 flex-wrap gap-2">
          <button id="visit-doctor" class="btn-primary px-4 py-2 rounded-lg">ูุฑุงุฌุนู ุจู ูพุฒุดฺฉ ุนููู</button>
          <button id="visit-specialist" class="btn-primary px-4 py-2 rounded-lg">ูุฑุงุฌุนู ุจู ูุชุฎุตุต</button>
          <button id="go-gym" class="btn-primary px-4 py-2 rounded-lg">ูุฑุฒุด</button>
          <button id="meditate" class="btn-primary px-4 py-2 rounded-lg">ูุฑุงูุจู</button>
        </div>
      </div>
      <div class="glass-card p-4 mt-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุจูุงุฑโูุง ู ุฏุฑูุงูโูุง</h3>
        <ul id="illness-list" class="space-y-2"></ul>
      </div>
    </div>

    <div id="career-categories-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('dashboard')">ุจุงุฒฺฏุดุช ุจู ุฏุงุดุจูุฑุฏ</button>
      </div>
      <h2 class="text-2xl font-bold mb-6 text-center flex-shrink-0">ุงูุชุฎุงุจ ูุณุฑ ุดุบู</h2>
      <div id="career-category-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 flex-grow overflow-y-auto">
        <!-- Job categories will be populated here by JavaScript -->
      </div>
    </div>

    <div id="job-listing-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button id="back-to-career-categories-btn" class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('career-categories-page')">ุจุงุฒฺฏุดุช ุจู ุฏุณุชูโุจูุฏ ูุดุงุบู</button>
      </div>
      <h2 id="job-listing-title" class="text-2xl font-bold mb-6 text-center flex-shrink-0">ูุณุช ูุดุงุบู</h2>
      <div id="job-list-container" class="space-y-4 flex-grow overflow-y-auto">
        <!-- Jobs for the selected category will be populated here by JavaScript -->
      </div>
    </div>

    <div id="job-details-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button id="back-to-job-listing-btn" class="btn-secondary px-4 py-2 rounded-lg">ุจุงุฒฺฏุดุช ุจู ูุณุช ูุดุงุบู</button> 
          <!-- The onclick for this button will be set dynamically by JavaScript to include current category -->
      </div>
      <div class="glass-card p-6 flex-grow overflow-y-auto"> <!-- Added flex-grow and overflow-y-auto -->
        <h2 id="job-detail-title" class="text-3xl font-bold mb-4 text-center">ูุงู ุดุบู</h2>
        <p id="job-detail-description" class="text-gray-300 mb-4">ุชูุถุญุงุช ุดุบู ุฏุฑ ุงูุฌุง ูุฑุงุฑ ูโฺฏุฑุฏ.</p>
        
        <div class="mb-4">
          <h3 class="text-xl font-semibold mb-2">ุงุทูุงุนุงุช ูพุงู:</h3>
          <p><strong>ุญููู ูุงูุงูู:</strong> <span id="job-detail-salary"></span> ุชููุงู</p>
          <p><strong>ุญุฏุงูู ุณู:</strong> <span id="job-detail-minAge"></span> ุณุงู</p>
        </div>

        <div class="mb-4">
          <h3 class="text-xl font-semibold mb-2">ุชุญุตูุงุช ููุฑุฏ ูุงุฒ:</h3>
          <p id="job-detail-educationReq"></p>
        </div>

        <div class="mb-4">
          <h3 class="text-xl font-semibold mb-2">ููุงุฑุชโูุง ููุฑุฏ ูุงุฒ:</h3>
          <ul id="job-detail-skillRequirements" class="list-disc list-inside text-gray-300">
            <!-- Skill requirements will be populated here -->
          </ul>
        </div>
        
        <div id="job-detail-promotion-info" class="mb-4" style="display: none;"> <!-- Hidden by default -->
          <h3 class="text-xl font-semibold mb-2">ูุณุฑ ุงุฑุชูุง:</h3>
          <p><strong>ุดุบู ุจุนุฏ:</strong> <span id="job-detail-promotionTo"></span></p>
          <p><strong>ุชุฌุฑุจู ูุงุฒู ุจุฑุง ุงุฑุชูุง:</strong> <span id="job-detail-experienceForPromotion"></span> ุณุงู</p>
        </div>

        <button id="apply-job-btn" class="btn-primary w-full py-3 rounded-lg text-lg font-semibold mt-6 flex-shrink-0">ุฏุฑุฎูุงุณุช ุจุฑุง ุงู ุดุบู</button>
      </div>
    </div>

    <!-- New Investment Page (ุตูุญู ุฌุฏุฏ ุณุฑูุงูโฺฏุฐุงุฑ) -->
    <div id="investment-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('dashboard'); window.showActivitiesMenu();">ุจุงุฒฺฏุดุช</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">ุณุฑูุงูโฺฏุฐุงุฑโูุง</h2>
      <div class="glass-card p-4 flex flex-col space-y-4 flex-shrink-0">
        <button id="gold_coins-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">? ุทูุง ู ุณฺฉู</button>
        <button id="stocks_bourse-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">๐ ุณูุงู ุจูุฑุณ</button>
        <button id="cryptocurrency-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">โฟ ุงุฑุฒ ุฏุฌุชุงู</button>
        <button id="investment_land-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">๐ก ุฒูู ู ุงููุงฺฉ</button>
        <button id="raw_materials-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">๐ฆ ููุงุฏ ุงููู</button>
      </div>
      <div class="glass-card p-4 mt-4 flex-grow overflow-y-auto"> <!-- Added flex-grow and overflow-y-auto -->
        <h3 class="text-lg font-semibold mb-2">ุณุฑูุงูโฺฏุฐุงุฑโูุง ูุนู ุดูุง:</h3>
        <ul id="current-investments-summary" class="mt-4 space-y-2"></ul>
      </div>
    </div>

    <!-- New detailed investment pages (ุตูุญุงุช ุฌุฒุฆุงุช ุณุฑูุงูโฺฏุฐุงุฑ ุฌุฏุฏ) -->
    <div id="gold_coins-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('investment-page')">ุจุงุฒฺฏุดุช ุจู ุณุฑูุงูโฺฏุฐุงุฑโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">๐ฐ ุทูุง ู ุณฺฉู</h2>
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-gold_coins-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-gold_coins-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>

    <div id="stocks_bourse-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('investment-page')">ุจุงุฒฺฏุดุช ุจู ุณุฑูุงูโฺฏุฐุงุฑโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">๐ ุณูุงู ุจูุฑุณ</h2>
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-stocks_bourse-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-stocks_bourse-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>

    <div id="cryptocurrency-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('investment-page')">ุจุงุฒฺฏุดุช ุจู ุณุฑูุงูโฺฏุฐุงุฑโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">โฟ ุงุฑุฒ ุฏุฌุชุงู</h2>
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-cryptocurrency-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-cryptocurrency-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>

    <div id="investment_land-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('investment-page')">ุจุงุฒฺฏุดุช ุจู ุณุฑูุงูโฺฏุฐุงุฑโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">๐ก ุฒูู ู ุงููุงฺฉ (ุณุฑูุงูโฺฏุฐุงุฑ)</h2>
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-investment_land-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-investment_land-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>

    <div id="raw_materials-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('investment-page')">ุจุงุฒฺฏุดุช ุจู ุณุฑูุงูโฺฏุฐุงุฑโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">๐ฆ ููุงุฏ ุงููู</h2>
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-raw_materials-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-raw_materials-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>


    <div id="assets-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <!-- Back button for Assets Page, returns to Dashboard (ุฏฺฉูู ุจุงุฒฺฏุดุช ุจุฑุง ุตูุญู ุฏุงุฑุงโูุงุ ุจู ุฏุงุดุจูุฑุฏ ุจุฑูโฺฏุฑุฏุฏ) -->
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('dashboard')">ุจุงุฒฺฏุดุช</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">ุฏุงุฑุงโูุง</h2>
      <!-- Vertical list of asset categories (ูุณุช ุนููุฏ ุฏุณุชูโุจูุฏโูุง ุฏุงุฑุง) -->
      <div id="assets-category-list" class="glass-card p-4 flex flex-col space-y-4 flex-grow overflow-y-auto"> <!-- Added flex-grow and overflow-y-auto -->
        <button id="properties-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">๐ ุงููุงฺฉ</button>
        <button id="vehicles-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">๐ ุฎูุฏุฑููุง</button>
        <button id="plane_boat-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">โ๏ธ/โต ููุงูพูุง/ูุงู</button>
        <button id="jewelry-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">๐ ุฌูุงูุฑุงุช</button>
        <button id="instruments-category-btn" class="btn-secondary w-full py-3 rounded-lg flex-shrink-0">๐ธ ุณุงุฒูุง</button>
        <!-- Removed investments-category-btn from assets, now in activities menu (ุณุฑูุงูโฺฏุฐุงุฑโูุง ุงุฒ ุฏุงุฑุงโูุง ุญุฐู ุดุฏุ ุงฺฉููู ุฏุฑ ููู ูุนุงูุชโูุง ุงุณุช) -->
      </div>
    </div>

    <!-- Asset Category Pages (pages for properties, vehicles, etc.) -->
    <!-- Property Page -->
    <div id="properties-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('assets-page')">ุจุงุฒฺฏุดุช ุจู ุฏุงุฑุงโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0"></h2> <!-- Title will be set by JS -->
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-properties-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-properties-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>

    <!-- Vehicles Page -->
    <div id="vehicles-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('assets-page')">ุจุงุฒฺฏุดุช ุจู ุฏุงุฑุงโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0"></h2> <!-- Title will be set by JS -->
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-vehicles-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-vehicles-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>

    <!-- Plane/Boat Page -->
    <div id="plane_boat-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('assets-page')">ุจุงุฒฺฏุดุช ุจู ุฏุงุฑุงโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0"></h2> <!-- Title will be set by JS -->
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-plane_boat-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-plane_boat-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>

    <!-- Jewelry Page -->
    <div id="jewelry-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('assets-page')">ุจุงุฒฺฏุดุช ุจู ุฏุงุฑุงโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0"></h2> <!-- Title will be set by JS -->
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-jewelry-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-jewelry-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>

    <!-- Instruments Page -->
    <div id="instruments-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('assets-page')">ุจุงุฒฺฏุดุช ุจู ุฏุงุฑุงโูุง</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0"></h2> <!-- Title will be set by JS -->
      <div class="glass-card p-4 mb-4 flex-shrink-0">
        <h3 class="text-lg font-semibold mb-2">ุฏุงุฑุงโูุง ูุนู ุดูุง:</h3>
        <div id="owned-instruments-list" class="space-y-2 asset-list-container max-h-40 overflow-y-auto"></div>
      </div>
      <div class="glass-card p-4 flex-grow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">ุจุฑุง ุฎุฑุฏ:</h3>
        <div id="buy-instruments-list" class="space-y-2 asset-list-container"></div>
      </div>
    </div>

    <div id="settings-page" style="display: none;" class="h-full page-content-scroll"> <!-- Changed min-h-screen to h-full -->
      <div class="back-button-container">
          <!-- Back button for Settings Page, returns to Dashboard (ุฏฺฉูู ุจุงุฒฺฏุดุช ุจุฑุง ุตูุญู ุชูุธูุงุชุ ุจู ุฏุงุดุจูุฑุฏ ุจุฑูโฺฏุฑุฏุฏ) -->
          <button class="btn-secondary px-4 py-2 rounded-lg" onclick="window.showPage('dashboard')">ุจุงุฒฺฏุดุช</button>
      </div>
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">ุชูุธูุงุช</h2>
      <div class="glass-card p-4 flex-grow overflow-y-auto"> <!-- Added flex-grow and overflow-y-auto -->
        <div class="mb-4">
          <label class="block mb-2">ุชู</label>
          <select id="theme-select" class="w-full p-2 bg-gray-800 rounded-lg">
            <option value="dark" selected>ุชุฑู</option>
            <option value="light">ุฑูุดู</option>
          </select>
        </div>
        <div class="flex space-x-2 flex-wrap gap-2">
          <button id="save-game" class="btn-primary px-4 py-2 rounded-lg">ุฐุฎุฑู</button>
          <button id="load-game" class="btn-primary px-4 py-2 rounded-lg">ุจุงุฑฺฏุฐุงุฑ</button>
          <button id="reset-game" class="btn-secondary px-4 py-2 rounded-lg">ุฑุณุช</button>
        </div>
      </div>
    </div>

    <!-- Game Over Screen (ุตูุญู ูพุงุงู ุจุงุฒ) -->
    <div id="game-over-screen" style="display: none;" class="flex flex-col items-center justify-center h-full">
      <h2>ูพุงุงู ุจุงุฒ!</h2>
      <p id="game-over-reason" class="text-center"></p>
      <div class="flex flex-col space-y-4 w-full max-w-xs">
        <button id="restart-game-btn" class="btn-primary w-full py-3 rounded-full text-lg font-semibold">ุดุฑูุน ุฒูุฏฺฏ ุฌุฏุฏ</button>
        <button id="view-log-btn" class="btn-secondary w-full py-3 rounded-full text-md">ูุดุงูุฏู ุชุงุฑุฎฺู ุฒูุฏฺฏ</button>
      </div>
    </div>

  </div> <!-- End of game-container -->

  <script type="module">
    // Global game state and other variables (ูุถุนุช ุณุฑุงุณุฑ ุจุงุฒ ู ุณุงุฑ ูุชุบุฑูุง)
    let gameState = {
      name: '',
      gender: '',
      province: '',
      familyStatus: '',
      age: 0,
      year: 2025,
      money: 0,
      happiness: 50,
      health: 80,
      smarts: 50,
      looks: 50,
      spirituality: 50,
      education: { level: 'ูฺ', major: '', degreeProgress: 0 },
      job: { title: 'ุจฺฉุงุฑ', salary: 0, level: 0, experience: 0 },
      relationships: [
        { id: 'parent1', name: 'ูพุฏุฑ', role: 'ูพุฏุฑ', relationship: 80, respect: 70, happiness: 60, age: 40 }, // Added age for parents
        { id: 'parent2', name: 'ูุงุฏุฑ', role: 'ูุงุฏุฑ', relationship: 85, respect: 75, happiness: 65, age: 38 } // Added age for parents
      ],
      romanticRelationships: [],
      children: [],
      illnesses: [],
      assets: [], // For properties, vehicles, jewelry, instruments
      loans: [],
      investments: [], // For gold, stocks, crypto, investment_land, raw_materials
      log: []
    };

    // Global variable to keep track of the last visited career category (ูุชุบุฑ ุณุฑุงุณุฑ ุจุฑุง ูพฺฏุฑ ุขุฎุฑู ุฏุณุชูโุจูุฏ ุดุบู ุจุงุฒุฏุฏ ุดุฏู)
    window.currentCareerCategory = null;

    const careerData = {
      'OFFICE_CORPORATE': {
        name: 'ูุดุงุบู ุงุฏุงุฑ ู ุดุฑฺฉุช',
        emoji: '๐ข',
        jobs: {
          'clerk': {
            name: 'ฺฉุงุฑููุฏ',
            description: 'ุงูุฌุงู ูุธุงู ุงุฏุงุฑ ู ุฏูุชุฑ.',
            salary: 5000000,
            minAge: 18,
            educationReq: 'ุฏูพูู',
            skillRequirements: ['ููุด: 40', 'ุดุงุฏ: 30'],
            promotion: { to: 'ูุฏุฑ ุงุฏุงุฑ', experience: 5 }
          },
          'admin_manager': {
            name: 'ูุฏุฑ ุงุฏุงุฑ',
            description: 'ูุธุงุฑุช ุจุฑ ุนููุงุช ุงุฏุงุฑ ู ฺฉุงุฑฺฉูุงู.',
            salary: 10000000,
            minAge: 25,
            educationReq: 'ูุณุงูุณ ูุฏุฑุช',
            skillRequirements: ['ููุด: 60', 'ุฑูุงุจุท: 50'],
            promotion: { to: 'ูุฏุฑ ุนุงูู', experience: 10 }
          }
        }
      },
      'SCIENCE_MEDICINE_TECHNICAL': { 
        name: 'ูุดุงุบู ุนููุ ูพุฒุดฺฉ ู ูู',
        emoji: '๐งช',
        jobs: {
          'doctor': {
            name: 'ูพุฒุดฺฉ ุนููู',
            description: 'ุชุดุฎุต ู ุฏุฑูุงู ุจูุงุฑโูุง ุนููู.',
            salary: 20000000,
            minAge: 26,
            educationReq: 'ุฏฺฉุชุฑุง ูพุฒุดฺฉ',
            skillRequirements: ['ููุด: 80', 'ุณูุงูุช: 70'],
            promotion: { to: 'ูุชุฎุตุต ุฌุฑุงุญ', experience: 7 }
          },
          'engineer': {
            name: 'ูููุฏุณ ูุฑูโุงูุฒุงุฑ',
            description: 'ุทุฑุงุญ ู ุชูุณุนู ูุฑูโุงูุฒุงุฑ.',
            salary: 15000000,
            minAge: 22,
            educationReq: 'ูุณุงูุณ ูููุฏุณ ฺฉุงููพูุชุฑ',
            skillRequirements: ['ููุด: 75', 'smarts: 70'],
            promotion: { to: 'ูุนูุงุฑ ูุฑูโุงูุฒุงุฑ', experience: 8 }
          }
        }
      },
      'LAW_GOVERNMENT': {
        name: 'ูุดุงุบู ุญููู', 
        emoji: 'โ๏ธ',
        jobs: {
          'lawyer': {
            name: 'ูฺฉู',
            description: 'ุงุฑุงุฆู ูุดุงูุฑู ุญููู ู ููุงูุฏฺฏ ุฏุฑ ุฏุงุฏฺฏุงู.',
            salary: 18000000,
            minAge: 25,
            educationReq: 'ูุณุงูุณ ุญููู',
            skillRequirements: ['ููุด: 70', 'ุฑูุงุจุท: 60'],
            promotion: { to: 'ูุงุถ', experience: 12 }
          }
        }
      },
      'ARTS_ENTERTAINMENT': {
        name: 'ูุดุงุบู ููุฑ ู ุณุฑฺฏุฑู',
        emoji: '๐ญ', /* Changed emoji from ? to ๐ญ as suggested by problem statement. */
        jobs: {
          'artist': {
            name: 'ููุงุด',
            description: 'ุฎูู ุขุซุงุฑ ููุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ ุฑูฺฏ ู ุจูู.',
            salary: 7000000,
            minAge: 18,
            educationReq: 'ุฏูพูู ููุฑ',
            skillRequirements: ['ุฎูุงูุช: 60', 'ุธุงูุฑ: 50'], // Assuming 'ุฎูุงูุช' as a skill for now
            promotion: null // No direct promotion
          }
        }
      },
      'EDUCATION_TRAINING': { 
        name: 'ูุดุงุบู ุขููุฒุด', 
        emoji: '๐',
        jobs: {
          'teacher': {
            name: 'ูุนูู',
            description: 'ุชุฏุฑุณ ุจู ุฏุงูุดโุขููุฒุงู ุฏุฑ ูุฏุงุฑุณ.',
            salary: 8000000,
            minAge: 22,
            educationReq: 'ูุณุงูุณ ุขููุฒุด',
            skillRequirements: ['ููุด: 60', 'ุดุงุฏ: 50'],
            promotion: { to: 'ูุฏุฑ ูุฏุฑุณู', experience: 10 }
          }
        }
      },
      'FINANCE_BUSINESS': { 
        name: 'ูุดุงุบู ุงูุชุตุงุฏ ู ูุงู',
        emoji: '๐ต' /* Changed to a more suitable emoji (ุชุบุฑ ุจู ุงููุฌ ููุงุณุจโุชุฑ) */,
        jobs: {
          'accountant': {
            name: 'ุญุณุงุจุฏุงุฑ',
            description: 'ูุฏุฑุช ุณูุงุจู ูุงู ู ุชูู ฺฏุฒุงุฑุดุงุช.',
            salary: 9000000,
            minAge: 20,
            educationReq: 'ูุณุงูุณ ุญุณุงุจุฏุงุฑ',
            skillRequirements: ['ููุด: 55', 'smarts: 60'],
            promotion: { to: 'ูุฏุฑ ูุงู', experience: 7 }
          }
        }
      },
      'TRANSPORT_TRAVEL': {
        name: 'ูุดุงุบู ุณูุฑ ู ุญููโูููู',
        emoji: 'โ๏ธ',
        jobs: {
          'driver': {
            name: 'ุฑุงููุฏู ุชุงฺฉุณ',
            description: 'ุญูู ู ููู ูุณุงูุฑ ุฏุฑ ุดูุฑ.',
            salary: 4000000,
            minAge: 20,
            educationReq: 'ุฏูพูู',
            skillRequirements: ['ุณูุงูุช: 60'],
            promotion: null 
          }
        }
      },
      'SKILLED_TRADES': {
        name: 'ูุดุงุบู ุฏุณุช ู ูู',
        emoji: '๐งฐ',
        jobs: {
          'electrician': {
            name: 'ุจุฑูฺฉุงุฑ',
            description: 'ูุตุจ ู ุชุนูุฑ ุณุณุชูโูุง ุจุฑู.',
            salary: 7000000,
            minAge: 18,
            educationReq: 'ูู ุญุฑููโุง',
            skillRequirements: ['ููุด: 50', 'ุฏูุช: 70'], // Assuming 'ุฏูุช' as a skill
            promotion: null
          }
        }
      },
      'ANIMAL_RELATED': {
        name: 'ูุดุงุบู ูุฑุจูุท ุจู ุญูุงูุงุช',
        emoji: '๐ถ',
        jobs: {
          'vet_assistant': {
            name: 'ุฏุณุชุงุฑ ุฏุงููพุฒุดฺฉ',
            description: 'ฺฉูฺฉ ุจู ุฏุงููพุฒุดฺฉ ุฏุฑ ูุฑุงูุจุช ุงุฒ ุญูุงูุงุช.',
            salary: 5500000,
            minAge: 18,
            educationReq: 'ุฏูพูู',
            skillRequirements: ['ููุฏู: 60', 'ุณูุงูุช: 50'], // Assuming 'ููุฏู' as a skill
            promotion: null
          }
        }
      },
      'HEALTHCARE_SUPPORT': { 
        name: 'ูุดุงุบู ุจูุฏุงุดุช', 
        emoji: '๐ฅ',
        jobs: {
          'nurse': {
            name: 'ูพุฑุณุชุงุฑ',
            description: 'ูุฑุงูุจุช ุงุฒ ุจูุงุฑุงู ู ฺฉูฺฉ ุจู ูพุฒุดฺฉุงู.',
            salary: 12000000,
            minAge: 22,
            educationReq: 'ูุณุงูุณ ูพุฑุณุชุงุฑ',
            skillRequirements: ['ููุฏู: 70', 'ุณูุงูุช: 65'],
            promotion: { to: 'ุณุฑูพุฑุณุชุงุฑ', experience: 8 }
          }
        }
      },
      'SERVICE_FOOD': {
        name: 'ูุดุงุบู ุฎุฏูุงุช ู ุบุฐุง',
        emoji: '๐จโ๐ณ',
        jobs: {
          'chef': {
            name: 'ุขุดูพุฒ',
            description: 'ุชูู ู ุทุจุฎ ุงููุงุน ุบุฐุงูุง.',
            salary: 6000000,
            minAge: 18,
            educationReq: 'ุฏูพูู ุขุดูพุฒ',
            skillRequirements: ['ุฎูุงูุช: 50', 'ุฏูุช: 60'],
            promotion: { to: 'ุณุฑุขุดูพุฒ', experience: 7 }
          }
        }
      },
      'PROFESSIONAL_SPORTS': {
        name: 'ูุฑุฒุดฺฉุงุฑุงู ู ูุฑุฒุด ุญุฑููโุง',
        emoji: '๐๏ธ',
        jobs: {
          'footballer': {
            name: 'ุจุงุฒฺฉู ููุชุจุงู',
            description: 'ุจุงุฒ ุญุฑููโุง ููุชุจุงู ุฏุฑ ุชูโูุง.',
            salary: 30000000,
            minAge: 18,
            educationReq: 'ุจุฏูู ูุงุฒ ุฑุณู',
            skillRequirements: ['ุณูุงูุช: 90', 'looks: 70'],
            promotion: null
          }
        }
      },
      'RARE_SPECIAL': {
        name: 'ุดุบูโูุง ุฎุงุต ู ฺฉูุงุจ',
        emoji: '๐' /* Changed emoji from ? to ๐ for rare/special jobs. */,
        jobs: {
          'astronaut': {
            name: 'ูุถุงููุฑุฏ',
            description: 'ุณูุฑ ู ุชุญูู ุฏุฑ ูุถุง.',
            salary: 50000000,
            minAge: 30,
            educationReq: 'ุฏฺฉุชุฑุง ุฏุฑ ุนููู ูุถุง/ูููุฏุณ',
            skillRequirements: ['ููุด: 95', 'ุณูุงูุช: 90'],
            promotion: null
          }
        }
      },
      'SPECIAL_DLC': { 
        name: 'ุดุบูโูุง ูุฎุตูุต',
        emoji: '๐ฎ',
        jobs: {
          'game_developer': {
            name: 'ุชูุณุนูโุฏููุฏู ุจุงุฒ',
            description: 'ุทุฑุงุญ ู ฺฉุฏููุณ ุจุงุฒโูุง ูุฏู.',
            salary: 12000000,
            minAge: 20,
            educationReq: 'ูุณุงูุณ ุนููู ฺฉุงููพูุชุฑ',
            skillRequirements: ['ููุด: 70', 'ุฎูุงูุช: 70'],
            promotion: null
          }
        }
      }
    };


    // Custom Message Modal (ููุฏุงู ูพุงู ุณูุงุฑุด)
    function showMessageModal(message) {
      const modalOverlay = document.createElement('div');
      modalOverlay.className = 'modal-overlay';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      
      const messageText = document.createElement('p');
      messageText.className = 'text-lg mb-4';
      messageText.textContent = message;
      
      const closeButton = document.createElement('button');
      closeButton.className = 'modal-button primary';
      closeButton.textContent = 'ุจุงุดู';
      closeButton.onclick = () => {
        document.body.removeChild(modalOverlay);
      };

      modalContent.appendChild(messageText);
      modalContent.appendChild(closeButton);
      modalOverlay.appendChild(modalContent);
      document.body.appendChild(modalOverlay);
    }

    // Override default confirm for custom modal (ุฌุงฺฏุฒู confirm ูพุดโูุฑุถ ุจุง ููุฏุงู ุณูุงุฑุด)
    window.confirm = function(message) {
      return new Promise((resolve) => {
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        
        const messageText = document.createElement('p');
        messageText.className = 'text-lg mb-4';
        messageText.textContent = message;
        
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'modal-button-container';

        const confirmButton = document.createElement('button');
        confirmButton.className = 'modal-button primary';
        confirmButton.textContent = 'ุจูู';
        confirmButton.onclick = () => {
          document.body.removeChild(modalOverlay);
          resolve(true);
        };

        const cancelButton = document.createElement('button');
        cancelButton.className = 'modal-button secondary';
        cancelButton.textContent = 'ุฎุฑ';
        cancelButton.onclick = () => {
          document.body.removeChild(modalOverlay);
          resolve(false);
        };

        buttonContainer.appendChild(confirmButton);
        buttonContainer.appendChild(cancelButton);
        modalContent.appendChild(messageText);
        modalContent.appendChild(buttonContainer);
        modalOverlay.appendChild(modalContent);
        document.body.appendChild(modalOverlay);
      });
    };

    // Initialize Game (ููุฏุงุฑุฏู ุงููู ุจุงุฒ)
    async function initGame() {
      console.log('Initializing game...'); // Debugging line

      // Set up global game container scaling (ุชูุธู ููุงุณโุจูุฏ ฺฉุงูุชูุฑ ุงุตู ุจุงุฒ)
      window.addEventListener('resize', resizeGame);
      resizeGame(); // Initial call to set correct scale (ูุฑุงุฎูุงู ุงููู ุจุฑุง ุชูุธู ููุงุณ ุตุญุญ)

      // Event Listeners for Start Screen (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ุตูุญู ุดุฑูุน)
      document.getElementById('start-new-life').addEventListener('click', startNewLife);
      document.getElementById('continue-life').addEventListener('click', continueLife);

      // Event Listeners for Bottom Tab Bar (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ููุงุฑ ุชุจ ูพุงู)
      document.getElementById('career-tab').addEventListener('click', () => window.showPage('career-categories-page'));
      document.getElementById('assets-tab').addEventListener('click', () => window.showPage('assets-page')); 
      document.getElementById('age-up-tab').addEventListener('click', ageUp);
      document.getElementById('relationships-main-tab').addEventListener('click', () => window.showPage('relationships-page'));
      document.getElementById('activities-tab').addEventListener('click', window.showActivitiesMenu); // Calls modal function directly

      // Event Listener for the new header settings button (ุดูููุฏู ุฑูุฏุงุฏ ุจุฑุง ุฏฺฉูู ุชูุธูุงุช ุฌุฏุฏ ุฏุฑ ูุฏุฑ)
      document.getElementById('header-settings-btn').addEventListener('click', () => window.showPage('settings-page'));

      // Event Listeners for Activities Menu (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ููู ูุนุงูุชโูุง)
      // These now hide the modal and then show the page (ุงููุง ุงฺฉููู ููุฏุงู ุฑุง ูพููุงู ฺฉุฑุฏู ู ุณูพุณ ุตูุญู ุฑุง ููุงุด ูโุฏููุฏ)
      document.getElementById('education-btn').addEventListener('click', () => { window.hideActivitiesMenu(); window.showEducationPage(); }); // Call new education entry point
      document.getElementById('health-btn').addEventListener('click', () => { window.hideActivitiesMenu(); window.showPage('health-page'); });
      document.getElementById('investments-btn').addEventListener('click', () => { window.hideActivitiesMenu(); window.showPage('investment-page'); }); // New: Go to investment page
      document.getElementById('close-activities-menu').addEventListener('click', window.hideActivitiesMenu); // Only hides the modal

      // Event Listeners for Settings Page (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ุตูุญู ุชูุธูุงุช)
      document.getElementById('save-game').addEventListener('click', saveGame);
      document.getElementById('load-game').addEventListener('click', loadGame);
      document.getElementById('reset-game').addEventListener('click', resetGame);
      
      // Event Listeners for Game Over Screen (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ุตูุญู ูพุงุงู ุจุงุฒ)
      document.getElementById('restart-game-btn').addEventListener('click', restartGame);
      document.getElementById('view-log-btn').addEventListener('click', () => {
        window.showPage('log-page');
        document.getElementById('game-over-screen').style.display = 'none'; // Hide game over screen
      });


      // Event Listeners for Health Page (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ุตูุญู ุณูุงูุช)
      document.getElementById('visit-doctor').addEventListener('click', visitDoctor);
      document.getElementById('visit-specialist').addEventListener('click', visitSpecialist);
      document.getElementById('go-gym').addEventListener('click', goGym);
      document.getElementById('meditate').addEventListener('click', meditate);

      // Event Listeners for Education Page (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ุตูุญู ุชุญุตูุงุช)
      // These are now handled within showEducationPage to set active tab (ุงููุง ุงฺฉููู ุฏุฑ showEducationPage ุจุฑุง ุชูุธู ุชุจ ูุนุงู ูุฏุฑุช ูโุดููุฏ)
      // document.getElementById('school-tab').addEventListener('click', showSchool); 
      // document.getElementById('university-tab').addEventListener('click', showUniversity);

      // Event Listeners for Assets Page category buttons (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ุฏฺฉููโูุง ุฏุณุชูโุจูุฏ ุตูุญู ุฏุงุฑุงโูุง)
      document.getElementById('properties-category-btn').addEventListener('click', () => window.showAssetCategoryPage('properties'));
      document.getElementById('vehicles-category-btn').addEventListener('click', () => window.showAssetCategoryPage('vehicles'));
      document.getElementById('plane_boat-category-btn').addEventListener('click', () => window.showAssetCategoryPage('plane_boat'));
      document.getElementById('jewelry-category-btn').addEventListener('click', () => window.showAssetCategoryPage('jewelry'));
      document.getElementById('instruments-category-btn').addEventListener('click', () => window.showAssetCategoryPage('instruments'));
      
      // Event Listeners for NEW Investment Page category buttons (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ุฏฺฉููโูุง ุฏุณุชูโุจูุฏ ุตูุญู ุณุฑูุงูโฺฏุฐุงุฑ ุฌุฏุฏ)
      document.getElementById('gold_coins-category-btn').addEventListener('click', () => window.showInvestmentCategoryPage('gold_coins'));
      document.getElementById('stocks_bourse-category-btn').addEventListener('click', () => window.showInvestmentCategoryPage('stocks_bourse'));
      document.getElementById('cryptocurrency-category-btn').addEventListener('click', () => window.showInvestmentCategoryPage('cryptocurrency'));
      document.getElementById('investment_land-category-btn').addEventListener('click', () => window.showInvestmentCategoryPage('investment_land'));
      document.getElementById('raw_materials-category-btn').addEventListener('click', () => window.showInvestmentCategoryPage('raw_materials'));

      // Event Listeners for Log Filters (ุดูููุฏูโูุง ุฑูุฏุงุฏ ุจุฑุง ููุชุฑูุง ุชุงุฑุฎฺู)
      document.getElementById('log-filter-all').addEventListener('click', () => filterLog('all'));
      document.getElementById('log-filter-career').addEventListener('click', () => filterLog('career'));
      document.getElementById('log-filter-family').addEventListener('click', () => filterLog('family'));
      document.getElementById('log-filter-health').addEventListener('click', () => filterLog('health'));
      document.getElementById('log-filter-education').addEventListener('click', () => filterLog('education'));
      
      // Event Listener for static "Find Partner" button (ุดูููุฏู ุฑูุฏุงุฏ ุจุฑุง ุฏฺฉูู ุซุงุจุช "ูพุฏุง ฺฉุฑุฏู ุดุฑฺฉ ุนุงุทู")
      document.getElementById('find-partner-btn').addEventListener('click', window.findPartner);


      // Initial UI update (ุจูโุฑูุฒุฑุณุงู ุงููู ุฑุงุจุท ฺฉุงุฑุจุฑ)
      updateUI();
      // Ensure only start screen is visible on initial load (ุงุทููุงู ุงุฒ ููุงุด ุชููุง ุตูุญู ุดุฑูุน ุฏุฑ ุจุงุฑฺฏุฐุงุฑ ุงููู)
      window.showPage('start-screen');
    }

    // Define base dimensions for the game container (ุชุนุฑู ุงุจุนุงุฏ ูพุงู ุจุฑุง ฺฉุงูุชูุฑ ุจุงุฒ)
    const BASE_WIDTH = 375; // Design width (ุนุฑุถ ุทุฑุงุญ)
    const BASE_HEIGHT = 667; // Design height (ุงุฑุชูุงุน ุทุฑุงุญ)

    // Function to resize and scale the game container (ุชุงุจุน ุจุฑุง ุชุบุฑ ุงูุฏุงุฒู ู ููุงุณโุจูุฏ ฺฉุงูุชูุฑ ุจุงุฒ)
    function resizeGame() {
      const gameContainer = document.getElementById('game-container');
      if (!gameContainer) return;

      const scaleX = window.innerWidth / BASE_WIDTH;
      const scaleY = window.innerHeight / BASE_HEIGHT;
      const scaleFactor = Math.min(scaleX, scaleY);

      gameContainer.style.setProperty('--scale-factor', scaleFactor);
    }

    // Start New Life (ุดุฑูุน ุฒูุฏฺฏ ุฌุฏุฏ)
    function startNewLife() {
      const nameInput = document.getElementById('name-input');
      const name = nameInput.value.trim();
      if (!name || name.length < 2) {
        showMessageModal('ูุทูุงู ูุงู ูุนุชุจุฑ (ุญุฏุงูู ฒ ุญุฑู) ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ.');
        nameInput.focus();
        return;
      }
      
      gameState = {
        name: name,
        gender: document.getElementById('gender-select').value,
        province: document.getElementById('province-select').value,
        familyStatus: document.getElementById('family-status').value,
        age: 0,
        year: 2025,
        money: 0,
        happiness: 50,
        health: 80,
        smarts: 50,
        looks: 50,
        spirituality: 50,
        education: { level: 'ูฺ', major: '', degreeProgress: 0 },
        job: { title: 'ุจฺฉุงุฑ', salary: 0, level: 0, experience: 0 },
        relationships: [
          { id: 'parent1', name: 'ูพุฏุฑ', role: 'ูพุฏุฑ', relationship: 80, respect: 70, happiness: 60, age: 40 }, 
          { id: 'parent2', name: 'ูุงุฏุฑ', role: 'ูุงุฏุฑ', relationship: 85, respect: 75, happiness: 65, age: 38 }
        ],
        romanticRelationships: [],
        children: [],
        illnesses: [],
        assets: [],
        investments: [],
        log: []
      };

      // Initial money based on family status (ูพูู ุงููู ุจุฑ ุงุณุงุณ ูุถุนุช ุฎุงููุงุฏฺฏ)
      switch (gameState.familyStatus) {
        case 'wealthy': gameState.money = 10000000; break;
        case 'poor': gameState.money = 100000; break;
        case 'rural': gameState.money = 200000; break;
        default: gameState.money = 500000; break;
      }

      gameState.log.push({ year: gameState.year, event: `ุดูุง ุฏุฑ ${document.querySelector(`#province-select option[value="${gameState.province}"]`).textContent} ูุชููุฏ ุดุฏุฏ!`, type: 'family' });
      
      updateUI();
      window.showPage('dashboard');
      saveGame();
    }

    // Continue Life (ุงุฏุงูู ุฒูุฏฺฏ)
    function continueLife() {
      try {
        const savedGameState = localStorage.getItem('iranianLifeSimState');
        if (savedGameState) {
          gameState = JSON.parse(savedGameState);
          // Ensure financeHistory is an array and has at least one entry (ุงุทููุงู ุงุฒ ุงูฺฉู financeHistory ฺฉ ุขุฑุงู ุงุณุช ู ุญุฏุงูู ฺฉ ูุฑูุฏ ุฏุงุฑุฏ)
          if (!gameState.financeHistory || gameState.financeHistory.length === 0) {
              gameState.financeHistory = [{ year: gameState.year, money: gameState.money }];
          }
          updateUI();
          window.showPage('dashboard');
          showMessageModal('ุจุงุฒ ุจุงุฑฺฏุฐุงุฑ ุดุฏ!');
        } else {
          showMessageModal('ูฺ ุฒูุฏฺฏ ุฐุฎุฑูโุดุฏูโุง ูุฌูุฏ ูุฏุงุฑุฏ!');
        }
      } catch (e) {
        console.error('Error loading game:', e);
        showMessageModal('ุฎุทุง ุฏุฑ ุจุงุฑฺฏุฐุงุฑ ุจุงุฒ! ูุงู ุฐุฎุฑู ุดุฏู ููฺฉู ุงุณุช ุฎุฑุงุจ ุจุงุดุฏ.');
      }
    }

    // Show Page (ููุงุด ุตูุญู)
    window.showPage = function(pageId) {
      console.log(`Attempting to show page: ${pageId}`); // Debugging line (ุฎุทุงุงุจ)
      if (document.activeElement && typeof document.activeElement.blur === 'function') {
        document.activeElement.blur();
      }
      const pages = [
        'start-screen', 'dashboard', 'character-page', 'log-page', 
        'education-page', 'career-categories-page', 'relationships-page', 
        'health-page', 'assets-page', 'settings-page',
        'job-listing-page', 'job-details-page', // Added career pages (ุตูุญุงุช ุดุบู ุงุถุงูู ุดุฏูุฏ)
        'properties-page', 'vehicles-page', 'plane_boat-page', 'jewelry-page', 'instruments-page',
        'investment-page', 'gold_coins-page', 'stocks_bourse-page', 'cryptocurrency-page', 'investment_land-page', 'raw_materials-page',
        'game-over-screen' // Add game over screen (ุตูุญู ูพุงุงู ุจุงุฒ ุงุถุงูู ุดุฏ)
      ];
      pages.forEach(page => {
        const element = document.getElementById(page);
        if (element) {
          element.style.display = 'none'; // Hide all pages explicitly (ูพููุงู ฺฉุฑุฏู ููู ุตูุญุงุช ุจู ุตูุฑุช ุตุฑุญ)
        }
      });

      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        // Determine the correct display type based on the pageId (ุชุนู ููุน ููุงุด ุตุญุญ ุจุฑ ุงุณุงุณ pageId)
        if (pageId === 'start-screen' || pageId === 'dashboard' || pageId === 'character-page' || pageId === 'log-page' || pageId === 'education-page' || pageId === 'relationships-page' || pageId === 'health-page' || pageId === 'career-categories-page' || pageId === 'job-listing-page' || pageId === 'job-details-page' || pageId === 'investment-page' || pageId === 'gold_coins-page' || pageId === 'stocks_bourse-page' || pageId === 'cryptocurrency-page' || pageId === 'investment_land-page' || pageId === 'raw_materials-page' || pageId === 'assets-page' || pageId === 'properties-page' || pageId === 'vehicles-page' || pageId === 'plane_boat-page' || pageId === 'jewelry-page' || pageId === 'instruments-page' || pageId === 'settings-page' || pageId === 'game-over-screen') { 
          targetPage.style.display = 'flex'; // These are all now flex containers (ุงููุง ููู ุงฺฉููู ฺฉุงูุชูุฑูุง ููฺฉุณ ูุณุชูุฏ)
        }
        console.log(`Page ${pageId} display set to: ${targetPage.style.display}`); // Debugging line (ุฎุทุงุงุจ)
      } else {
        console.error(`Error: Page with ID "${pageId}" not found.`); // Debugging line (ุฎุทุงุงุจ)
      }

      // Specific actions for certain pages
      if (pageId === 'career-categories-page') {
        window.showCareerCategories(); 
      }
      if (pageId === 'education-page') {
          window.showEducationPage(); // Ensure the education page loads correctly (ุงุทููุงู ุงุฒ ุจุงุฑฺฏุฐุงุฑ ุตุญุญ ุตูุญู ุชุญุตูุงุช)
      }

      updateUI();
    }

    // Show Activities Menu (ููุงุด ููู ูุนุงูุชโูุง) - Managed as a separate modal (ุจู ุนููุงู ฺฉ ููุฏุงู ุฌุฏุงฺฏุงูู ูุฏุฑุช ูโุดูุฏ)
    window.showActivitiesMenu = function() {
      document.getElementById('activities-menu').style.display = 'flex'; // Ensure it shows as flex (ุงุทููุงู ุงุฒ ููุงุด ุจู ุตูุฑุช ููฺฉุณ)
    }

    // Hide Activities Menu (ูพููุงู ฺฉุฑุฏู ููู ูุนุงูุชโูุง) - Managed as a separate modal (ุจู ุนููุงู ฺฉ ููุฏุงู ุฌุฏุงฺฏุงูู ูุฏุฑุช ูโุดูุฏ)
    window.hideActivitiesMenu = function() {
      document.getElementById('activities-menu').style.display = 'none'; // Ensure it hides (ุงุทููุงู ุงุฒ ูพููุงู ุดุฏู)
    }

    // Update UI (ุจูโุฑูุฒุฑุณุงู ุฑุงุจุท ฺฉุงุฑุจุฑ)
    function updateUI() {
      console.log('Updating UI...'); // Debugging line (ุฎุทุงุงุจ)
      // Update Combined Header (ุจูโุฑูุฒุฑุณุงู ูุฏุฑ ฺฉูพุงุฑฺู)
      document.getElementById('dashboard-char-name').textContent = gameState.name;
      // Only display age (ููุท ุณู ุฑุง ููุงุด ุฏูุฏ)
      document.getElementById('dashboard-char-age').textContent = `ุณู: ${gameState.age} ุณุงูู`; 
      document.getElementById('dashboard-char-money').textContent = `ูพูู: ${gameState.money.toLocaleString('fa-IR')} ุชููุงู`;
      document.getElementById('dashboard-char-job').textContent = `ุดุบู: ${gameState.job.title === 'ุจฺฉุงุฑ' && gameState.age < 18 ? 'ูุญุตู' : gameState.job.title}`;
      
      // Status Bars (ููุงุฑูุง ูุถุนุช)
      const updateStatusBar = (id, value) => {
        document.getElementById(`${id}-value`).textContent = `${value}%`;
        // ุนุฑุถ ููุงุฑ ุฑูฺฏ ุงฺฉููู ุชูุณุท ููุฏุงุฑ value ุชูุธู ูโุดูุฏ ู ุจู ุงูุชูุง ุณูุช ุฑุงุณุช ูโฺุณุจุฏ
        document.getElementById(`${id}-bar`).style.width = `${value}%`; 
      };
      updateStatusBar('happiness', gameState.happiness);
      updateStatusBar('health', gameState.health);
      updateStatusBar('smarts', gameState.smarts);
      updateStatusBar('looks', gameState.looks);
      updateStatusBar('spirituality', gameState.spirituality);

      // Character Page (ุตูุญู ุดุฎุตุช)
      document.getElementById('char-name').textContent = gameState.name;
      document.getElementById('char-gender').textContent = gameState.gender === 'male' ? 'ูุฑุฏ' : 'ุฒู';
      document.getElementById('char-province').textContent = document.querySelector(`#province-select option[value="${gameState.province}"]`)?.textContent || 'ูุงูุดุฎุต';
      document.getElementById('char-family').textContent = document.querySelector(`#family-status option[value="${gameState.familyStatus}"]`)?.textContent || 'ูุงูุดุฎุต';
      document.getElementById('char-age').textContent = gameState.age;
      document.getElementById('char-smarts').textContent = gameState.smarts;
      document.getElementById('char-looks').textContent = gameState.looks;
      document.getElementById('char-spirituality').textContent = gameState.spirituality;
      
      const familyList = document.getElementById('family-list');
      familyList.innerHTML = gameState.relationships.map(r => `<li>${r.name} (${r.role}) - ุฑุงุจุทู: ${r.relationship}%</li>`).join('');

      // Update Dashboard Life Log (ุจูโุฑูุฒุฑุณุงู ฺฏุฒุงุฑุด ุฒูุฏฺฏ ุฏุงุดุจูุฑุฏ)
      updateLifeLogOnDashboard();

      // Log Pages (ุตูุญุงุช ุชุงุฑุฎฺู) - This remains separate for the full log page
      filterLog('all'); // Always show all logs by default on update (ููุดู ููู ฺฏุฒุงุฑุดโูุง ุฑุง ุจูโุทูุฑ ูพุดโูุฑุถ ุฏุฑ ุจูโุฑูุฒุฑุณุงู ููุงุด ุฏูุฏ)

      // Education Page (ุตูุญู ุชุญุตูุงุช) - Now handled by showEducationPage
      // const currentEducationTab = document.querySelector('#education-page .btn-primary')?.id;
      // if (currentEducationTab === 'university-tab') {
      //   showUniversity();
      // } else {
      //   showSchool(); // Default to school (ูพุดโูุฑุถ ุจู ูุฏุฑุณู)
      // }

      // Relationships Page (ุตูุญู ุฑูุงุจุท)
      const relList = document.getElementById('relationships-list');
      relList.innerHTML = gameState.relationships.map(r => `
        <div class="glass-card p-4">
          <p><strong>${r.name}</strong> (${r.role})</p>
          <p>ุฑุงุจุทู: ${r.relationship}%</p>
          <div class="flex space-x-2 mt-2 flex-wrap gap-2">
            <button class="btn-primary px-2 py-1 rounded-lg" onclick="window.interact('${r.id}', 'talk')">ุตุญุจุช</button>
            <button class="btn-primary px-2 py-1 rounded-lg" onclick="window.interact('${r.id}', 'gift')">ูุฏู</button>
            <button class="btn-secondary px-2 py-1 rounded-lg" onclick="window.interact('${r.id}', 'argue')">ุฏุนูุง</button>
          </div>
        </div>
      `).join('');

      const romanticRelList = document.getElementById('romantic-relationships');
      romanticRelList.innerHTML = gameState.romanticRelationships.map(r => `
        <div class="glass-card p-4">
          <p><strong>${r.name}</strong> (${r.role})</p>
          <p>ุฑุงุจุทู: ${r.relationship}%</p>
          ${r.isMarried ? `<p class="text-emerald-400">๐ ูุชุงูู</p>` : ''}
          <div class="flex space-x-2 mt-2 flex-wrap gap-2">
            <button class="btn-primary px-2 py-1 rounded-lg" onclick="window.interactRomantic('${r.id}', 'talk')">ุตุญุจุช</button>
            <button class="btn-primary px-2 py-1 rounded-lg" onclick="window.interactRomantic('${r.id}', 'date')">ูุฑุงุฑ</button>
            ${!r.isMarried ? `<button class="btn-primary px-2 py-1 rounded-lg" onclick="window.proposeMarriage('${r.id}')">ูพุดููุงุฏ ุงุฒุฏูุงุฌ</button>` : ''}
            ${r.isMarried ? `<button class="btn-primary px-2 py-1 rounded-lg" onclick="window.tryForBaby('${r.id}')">ุจฺูโุฏุงุฑ ุดุฏู</button>` : ''}
            <button class="btn-secondary px-2 py-1 rounded-lg" onclick="window.breakup('${r.id}')">ฺฉุงุช ฺฉุฑุฏู</button>
          </div>
        </div>
      `).join('') || '<p>ูููุฒ ูฺ ุดุฑฺฉ ุนุงุทู ูุฏุงุฑุฏ.</p>';

      const childrenList = document.getElementById('children-list');
      if (childrenList) { // Check if element exists (ุจุฑุฑุณ ูุฌูุฏ ุนูุตุฑ)
        childrenList.innerHTML = gameState.children.map(child => `
          <div class="glass-card p-4">
            <p><strong>${child.name}</strong> (ุณู: ${child.age})</p>
            <p>ุฑุงุจุทู: ${child.relationship}%</p>
          </div>
        `).join('') || '<p>ูููุฒ ูุฑุฒูุฏ ูุฏุงุฑุฏ.</p>';
      }


      // Health Page (ุตูุญู ุณูุงูุช)
      document.getElementById('health-status').textContent = gameState.health + '%';
      const illnessList = document.getElementById('illness-list');
      illnessList.innerHTML = gameState.illnesses.length ? 
        gameState.illnesses.map(ill => `<li>${ill.name} (ุดุฏุช: ${ill.severity})</li>`).join('') : 
        '<li>ุณุงูู ูุณุชุฏ.</li>';
      document.getElementById('illnesses').textContent = gameState.illnesses.length ? gameState.illnesses.map(ill => ill.name).join(', ') : 'ุณุงูู';


      // Finance Page (ุตูุญู ูุงู)
      // updateFinanceChart() is now called only when finance page is shown
    
      // Investment Page Summary (ุฎูุงุตู ุตูุญู ุณุฑูุงูโฺฏุฐุงุฑ)
      const currentInvestmentsSummary = document.getElementById('current-investments-summary');
      if (currentInvestmentsSummary) { // Check if element exists (ุจุฑุฑุณ ูุฌูุฏ ุนูุตุฑ)
        currentInvestmentsSummary.innerHTML = gameState.investments.map(inv => `
          <li>${inv.emoji} ${inv.name} - ${inv.value.toLocaleString('fa-IR')} ุชููุงู (ุจุงุฒุฏู: ${(inv.growth * 100).toFixed(1)}%)</li>
        `).join('') || '<p class="text-gray-400">ูููุฒ ูฺ ุณุฑูุงูโฺฏุฐุงุฑ ูุฏุงุฑุฏ.</p>';
      }
    }

    window.showCareerCategories = function() {
      const listContainer = document.getElementById('career-category-list');
      if (!listContainer) {
        // If this happens, the HTML for career-categories-page is missing or malformed.
        console.error('CRITICAL: Career category list container (career-category-list) not found!');
        return;
      }
      listContainer.innerHTML = ''; // Clear previous categories

      // Directly use careerData, assuming it's defined in the same module scope.
      if (typeof careerData === 'undefined' || careerData === null || Object.keys(careerData).length === 0) {
        console.error('CRITICAL: careerData is undefined, null, or empty. Cannot populate categories.');
        listContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">ุฏุงุฏูโูุง ุฏุณุชูโุจูุฏ ุดุบู ุงูุช ูุดุฏ ุง ุฎุงู ุงุณุช.</p>';
        return;
      }

      let categoriesFound = false;
      for (const categoryKey in careerData) {
        if (careerData.hasOwnProperty(categoryKey)) {
          categoriesFound = true;
          const category = careerData[categoryKey];
          if (typeof category !== 'object' || category === null || !category.name || !category.emoji) {
            console.error('Skipping malformed category:', categoryKey, category);
            continue; // Skip this category if it's not structured as expected
          }

          const button = document.createElement('button');
          button.className = 'glass-card p-4 flex flex-col items-center justify-center text-center hover:bg-gray-700/70 transition duration-150 ease-in-out';
          button.innerHTML = `
            <span class="text-4xl mb-2">${category.emoji}</span>
            <span class="font-semibold">${category.name}</span>
          `;
          // Ensure window.showJobListingPage is correctly defined and accessible
          if (typeof window.showJobListingPage === 'function') {
            button.onclick = () => window.showJobListingPage(categoryKey);
          } else {
            console.error('CRITICAL: window.showJobListingPage is not defined. Cannot set onclick for category buttons.');
          }
          listContainer.appendChild(button);
        }
      }

      if (!categoriesFound) {
        console.error('No categories found in careerData after iterating.');
        listContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">ูฺ ุฏุณุชูโุจูุฏ ุจุฑุง ููุงุด ูุฌูุฏ ูุฏุงุฑุฏ.</p>';
      }
    }

    window.showJobListingPage = function(categoryKey) {
      console.log(`Showing job listing for category: ${categoryKey}`); // Debugging line (ุฎุทุงุงุจ)
      window.currentCareerCategory = categoryKey; // Store the current category (ุฏุณุชูโุจูุฏ ูุนู ุฑุง ุฐุฎุฑู ฺฉูุฏ)
      const category = careerData[categoryKey];
      if (!category) {
        console.error('Invalid career category key:', categoryKey);
        showMessageModal('ุฏุณุชู ุดุบู ูุงูุนุชุจุฑ ุงุณุช.');
        return;
      }

      const pageTitleElement = document.getElementById('job-listing-title');
      const listContainer = document.getElementById('job-list-container');

      if (!pageTitleElement || !listContainer) {
        console.error('Job listing page elements not found!');
        return;
      }

      pageTitleElement.innerHTML = `${category.emoji || ''} ${category.name}`;
      listContainer.innerHTML = ''; // Clear previous job listings

      const jobs = category.jobs;
      if (!jobs || Object.keys(jobs).length === 0) {
        listContainer.innerHTML = '<p class="text-gray-400 text-center">ุฏุฑ ุญุงู ุญุงุถุฑ ุดุบู ุฏุฑ ุงู ุฏุณุชู ููุฌูุฏ ูุณุช.</p>';
        window.showPage('job-listing-page');
        return;
      }

      for (const jobKey in jobs) {
        if (jobs.hasOwnProperty(jobKey)) {
          const job = jobs[jobKey];
          const jobCard = document.createElement('div');
          jobCard.className = 'glass-card p-4 flex flex-col sm:flex-row justify-between items-center';
          
          jobCard.innerHTML = `
            <div class="flex-grow">
              <h3 class="text-lg font-semibold text-emerald-400">${job.name}</h3>
              <p class="text-sm text-gray-300">ุญููู: ${job.salary.toLocaleString('fa-IR')} ุชููุงู</p>
              <p class="text-xs text-gray-400 mt-1">${job.description.substring(0, 100)}${job.description.length > 100 ? '...' : ''}</p>
            </div>
            <button class="btn-primary px-4 py-2 rounded-lg mt-3 sm:mt-0 sm:ml-4 flex-shrink-0" onclick="window.showJobDetailsPage('${categoryKey}', '${jobKey}')">ูุดุงูุฏู ุฌุฒุฆุงุช</button>
          `;
          listContainer.appendChild(jobCard);
        }
      }
      window.showPage('job-listing-page');
    }

    window.showJobDetailsPage = function(categoryKey, jobKey) {
      console.log(`Showing job details for: ${jobKey} in category: ${categoryKey}`); // Debugging line (ุฎุทุงุงุจ)
      const category = careerData[categoryKey];
      const job = category ? category.jobs[jobKey] : null;

      if (!job) {
        console.error('Invalid job or category key:', categoryKey, jobKey);
        showMessageModal('ุดุบู ููุฑุฏ ูุธุฑ ุงูุช ูุดุฏ.');
        return;
      }

      // Populate job details (ูพุฑ ฺฉุฑุฏู ุฌุฒุฆุงุช ุดุบู)
      document.getElementById('job-detail-title').textContent = job.name;
      document.getElementById('job-detail-description').textContent = job.description;
      document.getElementById('job-detail-salary').textContent = job.salary.toLocaleString('fa-IR');
      document.getElementById('job-detail-minAge').textContent = job.minAge;
      document.getElementById('job-detail-educationReq').textContent = job.educationReq;

      const skillRequirementsList = document.getElementById('job-detail-skillRequirements');
      skillRequirementsList.innerHTML = job.skillRequirements.map(skill => `<li>${skill}</li>`).join('');

      const promotionInfo = document.getElementById('job-detail-promotion-info');
      if (job.promotion) {
        document.getElementById('job-detail-promotionTo').textContent = job.promotion.to;
        document.getElementById('job-detail-experienceForPromotion').textContent = job.promotion.experience;
        promotionInfo.style.display = 'block';
      } else {
        promotionInfo.style.display = 'none';
      }

      // Set the back button's onclick dynamically (ุชูุธู ูพูุง onclick ุฏฺฉูู ุจุงุฒฺฏุดุช)
      const backButton = document.getElementById('back-to-job-listing-btn');
      if (backButton) {
        backButton.onclick = () => window.showJobListingPage(categoryKey);
      } else {
        console.error('Back to job listing button not found!');
      }

      // Set apply job button's onclick (ุชูุธู onclick ุฏฺฉูู ุฏุฑุฎูุงุณุช ุดุบู)
      const applyJobButton = document.getElementById('apply-job-btn');
      if (applyJobButton) {
        applyJobButton.onclick = () => window.applyJob(categoryKey, jobKey);
      } else {
        console.error('Apply job button not found!');
      }

      window.showPage('job-details-page');
    }

    window.applyJob = function(categoryKey, jobKey) {
      console.log(`Applying for job: ${jobKey} in category: ${categoryKey}`); // Debugging line (ุฎุทุงุงุจ)
      const category = careerData[categoryKey];
      const job = category ? category.jobs[jobKey] : null;

      if (!job) {
        showMessageModal('ุดุบู ููุฑุฏ ูุธุฑ ุงูุช ูุดุฏ.');
        return;
      }

      // Check requirements (ุจุฑุฑุณ ุงูุฒุงูุงุช)
      if (gameState.age < job.minAge) {
        showMessageModal(`ุจุฑุง ุงู ุดุบู ุจุงุฏ ุญุฏุงูู ${job.minAge} ุณุงู ุณู ุฏุงุดุชู ุจุงุดุฏ.`);
        return;
      }

      // Simplified education check (ุจุฑุฑุณ ุชุญุตูุงุช ุณุงุฏู ุดุฏู)
      if (job.educationReq !== 'ุจุฏูู ูุงุฒ ุฑุณู' && job.educationReq !== 'ูู ุญุฑููโุง') {
        const requiredLevel = job.educationReq.includes('ูุณุงูุณ') ? 'ุฏุงูุดฺฏุงู' : 'ุฏุจุฑุณุชุงู';
        if (gameState.education.level.indexOf(requiredLevel) === -1 && !gameState.education.level.includes('ูุงุฑุบโุงูุชุญุตู')) {
          showMessageModal(`ุจุฑุง ุงู ุดุบู ุจู ูุฏุฑฺฉ ${job.educationReq} ูุงุฒ ุฏุงุฑุฏ.`);
          return;
        }
      }

      // Skill check (ุจุฑุฑุณ ููุงุฑุชโูุง)
      let skillsMet = true;
      job.skillRequirements.forEach(req => {
        const [skillNameRaw, requiredValueRaw] = req.split(': ');
        const skillName = skillNameRaw.trim();
        const requiredValue = parseInt(requiredValueRaw);

        let currentSkillValue;
        switch (skillName) {
          case 'ููุด': currentSkillValue = gameState.smarts; break;
          case 'ุดุงุฏ': currentSkillValue = gameState.happiness; break;
          case 'ุณูุงูุช': currentSkillValue = gameState.health; break;
          case 'ุธุงูุฑ': currentSkillValue = gameState.looks; break;
          case 'ูุนููุช': currentSkillValue = gameState.spirituality; break;
          case 'ุฑูุงุจุท': // Assuming this refers to overall relationship status average (ูุฑุถ ุจุฑ ูุงูฺฏู ูุถุนุช ฺฉู ุฑูุงุจุท)
            currentSkillValue = gameState.relationships.reduce((acc, rel) => acc + rel.relationship, 0) / gameState.relationships.length;
            break;
          case 'ุฎูุงูุช': // Placeholder for creativity (ุฌุงฺฏุฒู ุจุฑุง ุฎูุงูุช)
          case 'ุฏูุช': // Placeholder for precision (ุฌุงฺฏุฒู ุจุฑุง ุฏูุช)
          case 'ููุฏู': // Placeholder for empathy (ุฌุงฺฏุฒู ุจุฑุง ููุฏู)
            currentSkillValue = 50; // Default or random value for now (ููุฏุงุฑ ูพุดโูุฑุถ ุง ุชุตุงุฏู ุจุฑุง ูุนูุงู)
            break;
          case 'smarts': currentSkillValue = gameState.smarts; break; // Added for consistency with previous code
          default: currentSkillValue = 0;
        }

        if (currentSkillValue < requiredValue) {
          skillsMet = false;
          showMessageModal(`ููุงุฑุช ${skillName} ุดูุง ฺฉุงู ูุณุช. (ูุงุฒ ุจู ${skillName} ${requiredValue}+ ุฏุงุฑุฏ)`);
        }
      });

      if (!skillsMet) {
        return; // Exit if skills are not met (ุฏุฑ ุตูุฑุช ุนุฏู ุชุทุงุจู ููุงุฑุชโูุง ุฎุงุฑุฌ ูโุดูุฏ)
      }

      // If all checks pass, apply for the job (ุฏุฑ ุตูุฑุช ุชุงุฏ ููู ููุงุฑุฏุ ุจุฑุง ุดุบู ุฏุฑุฎูุงุณุช ุฏูุฏ)
      gameState.job = {
        title: job.name,
        salary: job.salary,
        level: 1, // Starting at level 1 (ุดุฑูุน ุฏุฑ ุณุทุญ 1)
        experience: 0,
        category: categoryKey, // Store category for potential promotions (ุฐุฎุฑู ุฏุณุชูโุจูุฏ ุจุฑุง ุงุฑุชูุงุก ุงุญุชูุงู)
        key: jobKey // Store job key for specific job data (ุฐุฎุฑู ฺฉูุฏ ุดุบู ุจุฑุง ุฏุงุฏูโูุง ุดุบู ุฎุงุต)
      };
      gameState.log.push({ year: gameState.year, event: `ุดูุง ุจู ุนููุงู ${job.name} ุดุฑูุน ุจู ฺฉุงุฑ ฺฉุฑุฏุฏ.`, type: 'career' });
      showMessageModal(`ุชุจุฑฺฉ! ุดูุง ุจู ุนููุงู ${job.name} ุงุณุชุฎุฏุงู ุดุฏุฏ.`);
      updateUI();
      saveGame();
      window.showPage('dashboard'); // Return to dashboard after applying (ุจุงุฒฺฏุดุช ุจู ุฏุงุดุจูุฑุฏ ูพุณ ุงุฒ ุฏุฑุฎูุงุณุช)
    };


    // Age Up (ฺฉ ุณุงู ุจุฒุฑฺฏโุชุฑ ุดุฏู)
    async function ageUp() {
      // Check for character death before aging up (ุจุฑุฑุณ ูุฑฺฏ ฺฉุงุฑุงฺฉุชุฑ ูุจู ุงุฒ ุงูุฒุงุด ุณู)
      if (checkDeath()) {
          return; // If character dies, stop ageUp process (ุงฺฏุฑ ฺฉุงุฑุงฺฉุชุฑ ูุฑุฏุ ูุฑุขูุฏ ุงูุฒุงุด ุณู ูุชููู ุดูุฏ)
      }

      gameState.age++;
      gameState.year++;

      // Base stat changes (ุชุบุฑุงุช ูพุงู ุขูุงุฑ)
      gameState.happiness = Math.max(0, Math.min(100, gameState.happiness - 5 + Math.floor(Math.random() * 10)));
      gameState.health = Math.max(0, Math.min(100, gameState.health - 3 + Math.floor(Math.random() * 6)));
      gameState.smarts = Math.min(100, gameState.smarts + (gameState.education.level !== 'ูฺ' ? 2 : 0));
      gameState.looks = Math.max(0, Math.min(100, gameState.looks - 2 + Math.floor(Math.random() * 4)));
      gameState.spirituality = Math.min(100, gameState.spirituality + Math.floor(Math.random() * 5));
      
      // Health decay based on age (ฺฉุงูุด ุณูุงูุช ุจุฑ ุงุณุงุณ ุณู)
      if (gameState.age > 40) gameState.health = Math.max(0, gameState.health - 2);
      if (gameState.age > 60) gameState.health = Math.max(0, gameState.health - 5);
      if (gameState.age > 80) gameState.health = Math.max(0, gameState.health - 10); // More significant decay at old age (ฺฉุงูุด ูุงุจู ุชูุฌูโุชุฑ ุฏุฑ ุณูู ุจุงูุง)


      // Job salary (ุญููู ุดุบู)
      if (gameState.job.title !== 'ุจฺฉุงุฑ') {
        gameState.money += gameState.job.salary;
        gameState.job.experience += 1; // Gain experience (ุชุฌุฑุจู ฺฉุณุจ ูโฺฉูุฏ)
        gameState.log.push({ year: gameState.year, event: `ุญููู ูุงูุงูู ุฎูุฏ ุฑุง ุงุฒ ุดุบู ${gameState.job.title} ุฏุฑุงูุช ฺฉุฑุฏุฏ. (${gameState.job.salary.toLocaleString('fa-IR')} ุชููุงู)`, type: 'finance' });
        
        // Check for promotion (ุจุฑุฑุณ ุงุฑุชูุงุก)
        const currentJobData = careerData[gameState.job.category]?.jobs[gameState.job.key];
        if (currentJobData && currentJobData.promotion && gameState.job.experience >= currentJobData.promotion.experience) {
          const nextJobKey = Object.keys(careerData[gameState.job.category].jobs).find(key => careerData[gameState.job.category].jobs[key].name === currentJobData.promotion.to);
          if (nextJobKey) {
            const nextJobData = careerData[gameState.job.category].jobs[nextJobKey];
            gameState.job.title = nextJobData.name;
            gameState.job.salary = nextJobData.salary;
            gameState.job.level++;
            gameState.job.experience = 0; // Reset experience for new level (ุชุฌุฑุจู ุจุฑุง ุณุทุญ ุฌุฏุฏ ุจุงุฒูุดุงู ูโุดูุฏ)
            gameState.job.key = nextJobKey; // Update job key (ุจูโุฑูุฒุฑุณุงู ฺฉูุฏ ุดุบู)
            gameState.log.push({ year: gameState.year, event: `ุชุจุฑฺฉ! ุดูุง ุจู ${nextJobData.name} ุงุฑุชูุง ุงูุชุฏ!`, type: 'career' });
            showMessageModal(`ุชุจุฑฺฉ! ุดูุง ุจู ${nextJobData.name} ุงุฑุชูุง ุงูุชุฏ!`);
          }
        }
      }

      // Education progress (ูพุดุฑูุช ุชุญุตู)
      if (gameState.education.level === 'ุฏุงูุดฺฏุงู') {
          gameState.education.degreeProgress += 10 + Math.floor(Math.random() * 10); // 10-20% progress per year (ฑฐ-ฒฐูช ูพุดุฑูุช ุฏุฑ ุณุงู)
          if (gameState.education.degreeProgress >= 100) {
              gameState.education.degreeProgress = 100;
              gameState.education.level = `ูุงุฑุบโุงูุชุญุตู ${gameState.education.major}`;
              gameState.log.push({ year: gameState.year, event: `ุดูุง ุงุฒ ุฏุงูุดฺฏุงู ุฏุฑ ุฑุดุชู ${gameState.education.major} ูุงุฑุบโุงูุชุญุตู ุดุฏุฏ!`, type: 'education' });
              showMessageModal(`ุชุจุฑฺฉ! ุดูุง ุงุฒ ุฏุงูุดฺฏุงู ุฏุฑ ุฑุดุชู ${gameState.education.major} ูุงุฑุบโุงูุชุญุตู ุดุฏุฏ.`);
          } else {
              gameState.log.push({ year: gameState.year, event: `ุดูุง ุฏุฑ ุญุงู ุชุญุตู ุฏุฑ ุฑุดุชู ${gameState.education.major} ูุณุชุฏ. (${gameState.education.degreeProgress}% ูพุดุฑูุช)`, type: 'education' });
          }
      }

      // Investment growth (ุฑุดุฏ ุณุฑูุงูโฺฏุฐุงุฑ)
      gameState.investments.forEach(inv => {
        // Apply volatility to growth rate (ุงุนูุงู ููุณุงูุงุช ุจุฑ ูุฑุฎ ุฑุดุฏ)
        const volatilityFactor = (Math.random() * 2 - 1) * 0.1; // -0.1 to +0.1
        const actualGrowthRate = inv.growth + volatilityFactor;
        const growthAmount = inv.value * actualGrowthRate;
        inv.value = Math.max(0, inv.value + growthAmount); // Value cannot go below zero (ุงุฑุฒุด ููโุชูุงูุฏ ฺฉูุชุฑ ุงุฒ ุตูุฑ ุดูุฏ)
        
        // Log positive or negative growth (ุซุจุช ุฑุดุฏ ูุซุจุช ุง ููู)
        if (growthAmount >= 0) {
            gameState.log.push({ year: gameState.year, event: `ุณุฑูุงูโฺฏุฐุงุฑ ุดูุง ุฏุฑ ${inv.name} ุจู ูุจูุบ ${growthAmount.toLocaleString('fa-IR')} ุชููุงู ุณูุฏ ฺฉุฑุฏ. (ุงุฑุฒุด ูุนู: ${inv.value.toLocaleString('fa-IR')} ุชููุงู)`, type: 'finance' });
            if (growthAmount > 10000000 && Math.random() < 0.3) { // Large investment gain (ุณูุฏ ุจุฒุฑฺฏ ุณุฑูุงูโฺฏุฐุงุฑ)
                gameState.happiness = Math.min(100, gameState.happiness + 5);
            }
        } else {
            gameState.log.push({ year: gameState.year, event: `ุณุฑูุงูโฺฏุฐุงุฑ ุดูุง ุฏุฑ ${inv.name} ุจู ูุจูุบ ${Math.abs(growthAmount).toLocaleString('fa-IR')} ุชููุงู ุถุฑุฑ ฺฉุฑุฏ. (ุงุฑุฒุด ูุนู: ${inv.value.toLocaleString('fa-IR')} ุชููุงู)`, type: 'finance' });
            if (Math.abs(growthAmount) > 5000000 && Math.random() < 0.5) { // Significant investment loss (ุฒุงู ูุงุจู ุชูุฌู ุณุฑูุงูโฺฏุฐุงุฑ)
                gameState.happiness = Math.max(0, gameState.happiness - 10);
                showMessageModal(`ูุง! ุณุฑูุงูโฺฏุฐุงุฑ ุดูุง ุฏุฑ ${inv.name} ุฏฺุงุฑ ุงูุช ุดุฏุฏ ุดุฏ.`);
            }
        }
      });


      // Update children's age and handle family AI (ุจูโุฑูุฒุฑุณุงู ุณู ูุฑุฒูุฏุงู ู ูุฏุฑุช ููุด ูุตููุน ุฎุงููุงุฏู)
      for (let i = 0; i < gameState.relationships.length; i++) {
          const person = gameState.relationships[i];
          person.age = (person.age || 0) + 1; // Ensure age exists and increments (ุงุทููุงู ุงุฒ ูุฌูุฏ ู ุงูุฒุงุด ุณู)
          person.relationship = Math.max(0, person.relationship - 2 + Math.floor(Math.random() * 5)); // Slight decay + random fluctuation (ฺฉุงูุด ุฌุฒุฆ + ููุณุงู ุชุตุงุฏู)

          // AI for family members: asking for money (ููุด ูุตููุน ุจุฑุง ุงุนุถุง ุฎุงููุงุฏู: ุฏุฑุฎูุงุณุช ูพูู)
          if (person.role === 'ูุฑุฒูุฏ' && person.age > 18 && person.age < 25 && gameState.money > 2000000 && Math.random() < 0.05) {
              const amount = Math.floor(Math.random() * 5 + 1) * 100000; // 100,000 to 500,000
              const giveMoney = await window.confirm(`${person.name} ุงุฒ ุดูุง ${amount.toLocaleString('fa-IR')} ุชููุงู ูพูู ุฎูุงุณุช. ุขุง ูพุฑุฏุงุฎุช ูโฺฉูุฏุ`);
              if (giveMoney) {
                  gameState.money -= amount;
                  person.relationship = Math.min(100, person.relationship + 15);
                  gameState.happiness = Math.min(100, gameState.happiness + 5);
                  gameState.log.push({ year: gameState.year, event: `ุดูุง ุจู ${person.name} ูุจูุบ ${amount.toLocaleString('fa-IR')} ุชููุงู ฺฉูฺฉ ูุงู ฺฉุฑุฏุฏ.`, type: 'finance' });
              } else {
                  person.relationship = Math.max(0, person.relationship - 10);
                  gameState.happiness = Math.max(0, gameState.happiness - 5);
                  gameState.log.push({ year: gameState.year, event: `ุดูุง ุฏุฑุฎูุงุณุช ฺฉูฺฉ ูุงู ${person.name} ุฑุง ุฑุฏ ฺฉุฑุฏุฏ.`, type: 'family' });
              }
          }
          
          // AI for family members: leaving due to bad relationship (ููุด ูุตููุน ุจุฑุง ุงุนุถุง ุฎุงููุงุฏู: ุชุฑฺฉ ฺฉุฑุฏู ุจู ุฏูู ุฑุงุจุทู ุจุฏ)
          if (person.relationship < 20 && Math.random() < 0.1) {
              gameState.log.push({ year: gameState.year, event: `${person.name} ุจู ุฏูู ุฑุงุจุทู ุจุณุงุฑ ุจุฏ ุจุง ุดูุงุ ุชุตูู ุจู ุชุฑฺฉ ฺฉุฑุฏ.`, type: 'family' });
              showMessageModal(`${person.name} ุดูุง ุฑุง ุชุฑฺฉ ฺฉุฑุฏ!`);
              gameState.relationships.splice(i, 1);
              i--; // Adjust index due to removal (ุชูุธู ุงูุฏฺฉุณ ุจู ุฏูู ุญุฐู)
              gameState.happiness = Math.max(0, gameState.happiness - 15);
          }
      }

      // AI for romantic relationships (ููุด ูุตููุน ุจุฑุง ุฑูุงุจุท ุนุงุทู)
      for (let i = 0; i < gameState.romanticRelationships.length; i++) {
        const partner = gameState.romanticRelationships[i];
        partner.age = (partner.age || 0) + 1; // Assume partner also ages (ูุฑุถ ุจุฑ ุงู ุงุณุช ฺฉู ุดุฑฺฉ ูู ุณูุด ุจุงูุง ูโุฑูุฏ)
        partner.relationship = Math.max(0, partner.relationship - 3 + Math.floor(Math.random() * 7)); // Slight decay + fluctuation

        // Partner asks for money (ุดุฑฺฉ ุฏุฑุฎูุงุณุช ูพูู ูโฺฉูุฏ)
        if (partner.isMarried && gameState.money > 5000000 && Math.random() < 0.03) {
            const amount = Math.floor(Math.random() * 10 + 1) * 200000; // 200,000 to 2,000,000
            const giveMoney = await window.confirm(`${partner.name} ุงุฒ ุดูุง ${amount.toLocaleString('fa-IR')} ุชููุงู ุจุฑุง ฺฉ ูุงุฒ ูุงู ุฎูุงุณุช. ุขุง ูพุฑุฏุงุฎุช ูโฺฉูุฏุ`);
            if (giveMoney) {
                gameState.money -= amount;
                partner.relationship = Math.min(100, partner.relationship + 10);
                gameState.happiness = Math.min(100, gameState.happiness + 5);
                gameState.log.push({ year: gameState.year, event: `ุดูุง ุจู ${partner.name} ูุจูุบ ${amount.toLocaleString('fa-IR')} ุชููุงู ฺฉูฺฉ ูุงู ฺฉุฑุฏุฏ.`, type: 'finance' });
            } else {
                partner.relationship = Math.max(0, partner.relationship - 15);
                gameState.happiness = Math.max(0, gameState.happiness - 8);
                gameState.log.push({ year: gameState.year, event: `ุดูุง ุฏุฑุฎูุงุณุช ฺฉูฺฉ ูุงู ${partner.name} ุฑุง ุฑุฏ ฺฉุฑุฏุฏ.`, type: 'family' });
            }
        }

        // Partner initiates breakup if relationship is too low (ุดุฑฺฉ ุฏุฑ ุตูุฑุช ูพุงู ุจูุฏู ุฑุงุจุทูุ ุฌุฏุง ุฑุง ุขุบุงุฒ ูโฺฉูุฏ)
        if (!partner.isMarried && partner.relationship < 15 && Math.random() < 0.1) {
            gameState.log.push({ year: gameState.year, event: `${partner.name} ุฑุงุจุทู ุฑุง ุจุง ุดูุง ุจู ูู ุฒุฏ!`, type: 'family' });
            showMessageModal(`${partner.name} ุจุง ุดูุง ฺฉุงุช ฺฉุฑุฏ!`);
            gameState.romanticRelationships.splice(i, 1);
            i--;
            gameState.happiness = Math.max(0, gameState.happiness - 20);
        }
      }

      // Handle children aging (ูุฏุฑุช ุจุงูุง ุฑูุชู ุณู ูุฑุฒูุฏุงู)
      gameState.children.forEach(child => {
        child.age++;
        child.relationship = Math.min(100, child.relationship + Math.floor(Math.random() * 5)); // Slight improvement (ุจูุจูุฏ ุฌุฒุฆ)
      });


      // Smarter Random Events (ุฑูุฏุงุฏูุง ุชุตุงุฏู ููุดููุฏุงูู)
      const possibleEvents = [
        { 
            event: 'ุดูุง ฺฉ ุณุงู ุจุฒุฑฺฏโุชุฑ ุดุฏุฏ!', 
            type: 'general', 
            condition: () => true 
        },
        { 
            event: 'ุจู ฺฉ ุนุฑูุณ ุฏุนูุช ุดุฏุฏ ู ุงููุงุช ุฎูุด ุฑุง ฺฏุฐุฑุงูุฏุฏ!', 
            type: 'family', 
            condition: () => gameState.happiness < 90 && gameState.age > 18, 
            effect: () => gameState.happiness = Math.min(100, gameState.happiness + 10) 
        },
        { 
            event: 'ฺฉ ุจูุงุฑ ุฎูู ฺฏุฑูุชุฏ.', 
            type: 'health', 
            condition: () => gameState.health > 20 && Math.random() < 0.2, // More likely if not already very sick (ุงุญุชูุงู ุจุดุชุฑ ุงฺฏุฑ ูููุฒ ุฎู ุจูุงุฑ ูุจุงุดุฏ)
            effect: () => { 
                gameState.health = Math.max(0, gameState.health - 10); 
                gameState.illnesses.push({ name: 'ุณุฑูุงุฎูุฑุฏุงู', severity: 'ุฎูู' }); 
            } 
        },
        { 
            event: 'ฺฉ ุฏูุณุช ุฌุฏุฏ ูพุฏุง ฺฉุฑุฏุฏ!', 
            type: 'family', 
            condition: () => gameState.age >= 10 && gameState.relationships.length < 5 && Math.random() < 0.1, 
            effect: () => gameState.relationships.push({ id: crypto.randomUUID(), name: 'ุฏูุณุช ุฌุฏุฏ', role: 'ุฏูุณุช', relationship: 50, respect: 50, happiness: 50, age: gameState.age }) 
        },
        { 
            event: 'ฺฉ ุฌุงุฒู ฺฉูฺฺฉ ุฏุฑ ูุฑุนูโฺฉุด ุจุฑุฏุฏ!', 
            type: 'finance', 
            condition: () => Math.random() < 0.05, 
            effect: () => gameState.money += 100000 
        },
        { 
            event: 'ุฏุฑ ุชุฑุงูฺฉ ุณูฺฏู ฺฏุฑ ฺฉุฑุฏุฏ ู ุฏุฑุชุงู ุดุฏ.', 
            type: 'general', 
            condition: () => Math.random() < 0.1, 
            effect: () => gameState.happiness = Math.max(0, gameState.happiness - 5) 
        },
        { 
            event: 'ฺฉ ฺฉุชุงุจ ุฌุฏุฏ ุฎูุงูุฏุฏ ู ููุด ุดูุง ุงูุฒุงุด ุงูุช.', 
            type: 'education', 
            condition: () => gameState.smarts < 95 && Math.random() < 0.15, 
            effect: () => gameState.smarts = Math.min(100, gameState.smarts + 3) 
        },
        { 
            event: 'ูุฏุช ุฑุง ุฏุฑ ุทุจุนุช ฺฏุฐุฑุงูุฏุฏ ู ูุนููุช ุดูุง ุงูุฒุงุด ุงูุช.', 
            type: 'spirituality', 
            condition: () => gameState.spirituality < 95 && Math.random() < 0.1, 
            effect: () => gameState.spirituality = Math.min(100, gameState.spirituality + 5) 
        },
        { 
            event: 'ฺฉ ูุณูู ุงูฺฉุชุฑููฺฉ ุดูุง ุฎุฑุงุจ ุดุฏ ู ูุฌุจูุฑ ุจู ุชุนูุฑ ุดุฏุฏ.', 
            type: 'finance', 
            condition: () => gameState.money > 50000 && Math.random() < 0.1, 
            effect: () => gameState.money = Math.max(0, gameState.money - 50000) 
        },
        { 
            event: 'ุฏุฑ ูุญู ฺฉุงุฑ ุจุง ููฺฉุงุฑุงูุชุงู ุจู ูุดฺฉู ุฎูุฑุฏุฏ.', 
            type: 'career', 
            condition: () => gameState.job.title !== 'ุจฺฉุงุฑ' && Math.random() < 0.08, 
            effect: () => gameState.happiness = Math.max(0, gameState.happiness - 8) 
        },
        { 
            event: 'ฺฉ ุฏูุฑู ุขููุฒุด ุขููุงู ฺฏุฐุฑุงูุฏุฏ ู ููุงุฑุชโูุงุชุงู ุจูุจูุฏ ุงูุช.', 
            type: 'education', 
            condition: () => gameState.smarts < 90 && Math.random() < 0.07, 
            effect: () => gameState.smarts = Math.min(100, gameState.smarts + 7) 
        },
        { 
            event: 'ุจู ฺฉ ุณูุฑ ฺฉูุชุงู ุฑูุชุฏ ู ุฑูุญู ฺฏุฑูุชุฏ.', 
            type: 'general', 
            condition: () => gameState.money > 2000000 && gameState.happiness < 80 && Math.random() < 0.05, 
            effect: () => gameState.happiness = Math.min(100, gameState.happiness + 15) 
        },
        {
            event: 'ุจุง ุณุฑูุงูโฺฏุฐุงุฑ ููุดููุฏุงููุ ุณูุฏ ุฎูุจ ฺฉุณุจ ฺฉุฑุฏุฏ!',
            type: 'finance',
            condition: () => gameState.investments.length > 0 && Math.random() < 0.05,
            effect: () => {
                const investment = gameState.investments[Math.floor(Math.random() * gameState.investments.length)];
                const bonus = investment.value * 0.1; // 10% bonus
                gameState.money += bonus;
                gameState.happiness = Math.min(100, gameState.happiness + 10);
                gameState.log.push({ year: gameState.year, event: `ุณุฑูุงูโฺฏุฐุงุฑ ุฏุฑ ${investment.name} ุจู ุดูุง ${bonus.toLocaleString('fa-IR')} ุชููุงู ุณูุฏ ูุงุฒุงุฏ ุฏุงุฏ!`, type: 'finance' });
            }
        },
        {
            event: 'ฺฉ ุงุฒ ุฏุงุฑุงโูุง ุดูุง ูุงุฒ ุจู ุชุนูุฑ ูพุฏุง ฺฉุฑุฏ ู ูุฒูู ุฏุงุดุช.',
            type: 'finance',
            condition: () => gameState.assets.length > 0 && gameState.money > 100000 && Math.random() < 0.07,
            effect: () => {
                const cost = Math.floor(Math.random() * 5 + 1) * 10000; // 10k to 50k
                gameState.money = Math.max(0, gameState.money - cost);
                gameState.happiness = Math.max(0, gameState.happiness - 3);
                gameState.log.push({ year: gameState.year, event: `ูุฒูู ุชุนูุฑ ฺฉ ุงุฒ ุฏุงุฑุงโูุง: ${cost.toLocaleString('fa-IR')} ุชููุงู.`, type: 'finance' });
            }
        }
      ];

      // Filter events based on conditions (ููุชุฑ ฺฉุฑุฏู ุฑูุฏุงุฏูุง ุจุฑ ุงุณุงุณ ุดุฑุงุท)
      const applicableEvents = possibleEvents.filter(event => event.condition());
      
      // Pick one random applicable event (ุงูุชุฎุงุจ ฺฉ ุฑูุฏุงุฏ ุชุตุงุฏู ุงุฒ ูุงู ุฑูุฏุงุฏูุง ูุงุจู ุงุฌุฑุง)
      let chosenEvent = { event: 'ฺฉ ุณุงู ุงุฒ ุฒูุฏฺฏ ุดูุง ฺฏุฐุดุช.', type: 'general' }; // Default event (ุฑูุฏุงุฏ ูพุดโูุฑุถ)
      if (applicableEvents.length > 0) {
          chosenEvent = applicableEvents[Math.floor(Math.random() * applicableEvents.length)];
      }

      gameState.log.push({ year: gameState.year, event: chosenEvent.event, type: chosenEvent.type });
      if (chosenEvent.effect) chosenEvent.effect();


      updateUI();
      saveGame();
    }

    // --- Death System Functions (ุชูุงุจุน ุณุณุชู ูุฑฺฏ) ---
    function checkDeath() {
      let deathReason = null;

      // 1. Natural Death (ูุฑฺฏ ุทุจุน)
      if (gameState.age >= 60 && Math.random() < (gameState.age - 50) * 0.01) { // Chance increases after 60 (ุดุงูุณ ุจุนุฏ ุงุฒ ถฐ ุณุงูฺฏ ุงูุฒุงุด ูโุงุจุฏ)
        deathReason = `ุดูุง ุฏุฑ ุณู ${gameState.age} ุณุงูฺฏ ุจู ูุฑฺฏ ุทุจุน ุงุฒ ุฏูุง ุฑูุชุฏ.`;
      }
      // 2. Illness Death (ูุฑฺฏ ุจุฑ ุงุซุฑ ุจูุงุฑ)
      if (gameState.health < 10 && gameState.illnesses.length > 0 && Math.random() < 0.3) {
        deathReason = `ุดูุง ุฏุฑ ุงุซุฑ ุนูุงุฑุถ ุจูุงุฑโูุงุชุงู ุฏุฑ ุณู ${gameState.age} ุณุงูฺฏ ุฏุฑฺฏุฐุดุชุฏ.`;
      }
      // 3. Accident Death (ูุฑฺฏ ุจุฑ ุงุซุฑ ุญุงุฏุซู)
      if (Math.random() < 0.005) { // 0.5% chance each year (ฐ.ตูช ุดุงูุณ ุฏุฑ ูุฑ ุณุงู)
        deathReason = `ูุชุงุณูุงูู ุฏุฑ ุณู ${gameState.age} ุณุงูฺฏ ุฏฺุงุฑ ฺฉ ุญุงุฏุซู ูุงฺฏูุงุฑ ุดุฏุฏ ู ููุช ฺฉุฑุฏุฏ.`;
      }
      
      // AI for parents dying (ููุด ูุตููุน ุจุฑุง ููุช ูุงูุฏู)
      for (let i = 0; i < gameState.relationships.length; i++) {
          const person = gameState.relationships[i];
          if ((person.role === 'ูพุฏุฑ' || person.role === 'ูุงุฏุฑ') && person.age > 70 && Math.random() < (person.age - 60) * 0.008) {
              gameState.log.push({ year: gameState.year, event: `${person.name} ุดูุง ุฏุฑ ุณู ${person.age} ุณุงูฺฏ ุจู ุฏูู ฺฉูููุช ุณู ููุช ฺฉุฑุฏ.`, type: 'family' });
              showMessageModal(`${person.name} ุดูุง ุฏุฑฺฏุฐุดุช.`);
              gameState.relationships.splice(i, 1);
              i--; // Adjust index due to removal
              gameState.happiness = Math.max(0, gameState.happiness - 10); // Impact on player's happiness (ุชุงุซุฑ ุจุฑ ุดุงุฏ ุจุงุฒฺฉู)
          }
      }

      if (deathReason) {
        handleGameOver(deathReason);
        return true; // Character died (ฺฉุงุฑุงฺฉุชุฑ ูุฑุฏ)
      }
      return false; // Character did not die (ฺฉุงุฑุงฺฉุชุฑ ููุฑุฏ)
    }

    function handleGameOver(reason) {
      window.showPage('game-over-screen');
      document.getElementById('game-over-reason').textContent = reason;
      saveGame(); // Save final state (ุฐุฎุฑู ูุถุนุช ููุง)
    }

    function restartGame() {
        resetGame(); // Reset game state (ูุถุนุช ุจุงุฒ ุฑุง ุฑุณุช ูโฺฉูุฏ)
        window.showPage('start-screen'); // Show start screen (ุตูุญู ุดุฑูุน ุฑุง ููุงุด ูโุฏูุฏ)
    }

    // --- Education Revamp Functions (ุชูุงุจุน ุจุงุฒุณุงุฒ ุชุญุตูุงุช) ---

    // Main entry point for education page (ููุทู ูุฑูุฏ ุงุตู ุจุฑุง ุตูุญู ุชุญุตูุงุช)
    window.showEducationPage = function() {
        window.showPage('education-page');
        // Determine which tab to show by default (ุชุนู ุงูฺฉู ฺฉุฏุงู ุชุจ ุจูโุทูุฑ ูพุดโูุฑุถ ููุงุด ุฏุงุฏู ุดูุฏ)
        if (gameState.age < 18) {
            window.showSchool();
        } else {
            // If already university level or graduated, show university. Otherwise, still school for general study.
            if (gameState.education.level.includes('ุฏุงูุดฺฏุงู') || gameState.education.level.includes('ูุงุฑุบโุงูุชุญุตู')) {
                window.showUniversity();
            } else {
                window.showSchool(); // Even if over 18, still show school for "general study" (ุญุช ุงฺฏุฑ ุจุงูุง ฑธ ุณุงู ุจุงุดุฏุ ููฺูุงู ูุฏุฑุณู ุฑุง ุจุฑุง "ูุทุงูุนู ุนููู" ูุดุงู ุฏูุฏ)
            }
        }
    };

    window.showSchool = function() {
      const content = document.getElementById('education-content-scroll');
      let htmlContent = '';

      // Update tab styles (ุจูโุฑูุฒุฑุณุงู ุงุณุชุงู ุชุจโูุง)
      document.getElementById('school-tab').classList.add('btn-primary');
      document.getElementById('school-tab').classList.remove('btn-secondary');
      document.getElementById('university-tab').classList.add('btn-secondary');
      document.getElementById('university-tab').classList.remove('btn-primary');

      if (gameState.age < 6) {
        htmlContent = `<div class="glass-card p-4 text-center">
                         <p class="text-lg">ุดูุง ุจุฑุง ุดุฑูุน ุชุญุตู ุฎู ฺฉูฺฺฉ ูุณุชุฏ.</p>
                       </div>`;
      } else if (gameState.age < 12) {
        htmlContent = `
          <div class="glass-card p-4 mb-4">
            <h3 class="text-lg font-semibold mb-2">ููุทุน ุงุจุชุฏุง</h3>
            <p><strong>ูุถุนุช:</strong> ${gameState.education.level === 'ุงุจุชุฏุง' ? 'ุฏุฑ ุญุงู ุชุญุตู' : 'ูุงุฑุบโุงูุชุญุตู'}</p>
            <p class="text-sm text-gray-300 mt-2">ุจุง ุฏุฑุณ ุฎูุงูุฏู ููุด ุฎูุฏ ุฑุง ุงูุฒุงุด ุฏูุฏ.</p>
            <button class="btn-primary w-full py-2 rounded-lg mt-4" onclick="window.study('primary')">ุฏุฑุณ ุจุฎูุงูุฏ (ุงูุฒุงุด ููุดุ +5)</button>
          </div>
        `;
      } else if (gameState.age < 15) {
        htmlContent = `
          <div class="glass-card p-4 mb-4">
            <h3 class="text-lg font-semibold mb-2">ููุทุน ุฑุงูููุง</h3>
            <p><strong>ูุถุนุช:</strong> ${gameState.education.level === 'ุฑุงูููุง' ? 'ุฏุฑ ุญุงู ุชุญุตู' : 'ูุงุฑุบโุงูุชุญุตู'}</p>
            <p class="text-sm text-gray-300 mt-2">ููุงุฑุชโูุง ูพุงู ุฎูุฏ ุฑุง ุชููุช ฺฉูุฏ.</p>
            <button class="btn-primary w-full py-2 rounded-lg mt-4" onclick="window.study('middle')">ุฏุฑุณ ุจุฎูุงูุฏ (ุงูุฒุงุด ููุดุ +5)</button>
          </div>
        `;
      } else if (gameState.age < 18) {
        htmlContent = `
          <div class="glass-card p-4 mb-4">
            <h3 class="text-lg font-semibold mb-2">ููุทุน ุฏุจุฑุณุชุงู</h3>
            <p><strong>ูุถุนุช:</strong> ${gameState.education.level === 'ุฏุจุฑุณุชุงู' ? 'ุฏุฑ ุญุงู ุชุญุตู' : 'ูุงุฑุบโุงูุชุญุตู'}</p>
            <p class="text-sm text-gray-300 mt-2">ุจุฑุง ูุฑูุฏ ุจู ุฏุงูุดฺฏุงู ุขูุงุฏู ุดูุฏ.</p>
            <button class="btn-primary w-full py-2 rounded-lg mt-4" onclick="window.study('high')">ุฏุฑุณ ุจุฎูุงูุฏ (ุงูุฒุงุด ููุดุ +5)</button>
          </div>
        `;
      } else {
        htmlContent = `
          <div class="glass-card p-4 text-center">
            <h3 class="text-lg font-semibold mb-2">ุชุญุตูุงุช ูุฏุฑุณู</h3>
            <p>ุดูุง ุชุญุตูุงุช ูุฏุฑุณู ุฑุง ุจู ูพุงุงู ุฑุณุงูุฏูโุงุฏ.</p>
            <p class="text-sm text-gray-300 mt-2">ุจุง ูุทุงูุนู ุขุฒุงุฏ ูโุชูุงูุฏ ุจู ุฏุงูุด ุฎูุฏ ุจุงูุฒุงุฏ.</p>
            <button class="btn-primary w-full py-2 rounded-lg mt-4" onclick="window.study('general')">ูุทุงูุนู ุขุฒุงุฏ (ุงูุฒุงุด ููุดุ +3)</button>
          </div>
        `;
      }
      content.innerHTML = htmlContent;
    }

    window.showUniversity = function() {
      const content = document.getElementById('education-content-scroll');
      let htmlContent = '';

      // Update tab styles (ุจูโุฑูุฒุฑุณุงู ุงุณุชุงู ุชุจโูุง)
      document.getElementById('university-tab').classList.add('btn-primary');
      document.getElementById('university-tab').classList.remove('btn-secondary');
      document.getElementById('school-tab').classList.add('btn-secondary');
      document.getElementById('school-tab').classList.remove('btn-primary');

      if (gameState.age < 18 || !(gameState.education.level.includes('ุฏุจุฑุณุชุงู') || gameState.education.level.includes('ูุงุฑุบโุงูุชุญุตู'))) {
        htmlContent = `<div class="glass-card p-4 text-center">
                         <p class="text-lg">ุจุฑุง ูุฑูุฏ ุจู ุฏุงูุดฺฏุงู ุจุงุฏ ุญุฏุงูู ฑธ ุณุงู ุฏุงุดุชู ุจุงุดุฏ ู ุฏุจุฑุณุชุงู ุฑุง ุชูุงู ฺฉุฑุฏู ุจุงุดุฏ.</p>
                       </div>`;
      } else {
        if (gameState.education.level === 'ุฏุงูุดฺฏุงู') {
          htmlContent = `
            <div class="glass-card p-4 mb-4">
              <h3 class="text-lg font-semibold mb-2">ุฏุงูุดฺฏุงู</h3>
              <p><strong>ุฑุดุชู ูุนู:</strong> ${gameState.education.major}</p>
              <p><strong>ูพุดุฑูุช ูุฏุฑฺฉ:</strong> ${gameState.education.degreeProgress}%</p>
              <p class="text-sm text-gray-300 mt-2">ุจุง ุงุฏุงูู ุชุญุตู ุฏุฑ ุฑุดุชู ุฎูุฏุ ูพุดุฑูุช ฺฉูุฏ.</p>
              <button class="btn-primary w-full py-2 rounded-lg mt-4" onclick="window.continueUniversityStudy()">ุงุฏุงูู ุชุญุตู (ุงูุฒุงุด ูพุดุฑูุชุ +10-20)</button>
              <button class="btn-secondary w-full py-2 rounded-lg mt-2" onclick="window.dropOut()">ุงูุตุฑุงู ุงุฒ ุชุญุตู</button>
            </div>
          `;
        } else if (gameState.education.level.includes('ูุงุฑุบโุงูุชุญุตู')) {
          htmlContent = `
            <div class="glass-card p-4 text-center">
              <h3 class="text-lg font-semibold mb-2">ูุงุฑุบโุงูุชุญุตู</h3>
              <p>ุดูุง ุงุฒ ุฏุงูุดฺฏุงู ุฏุฑ ุฑุดุชู ${gameState.education.major || 'ูุงูุดุฎุต'} ูุงุฑุบโุงูุชุญุตู ุดุฏูโุงุฏ.</p>
              <p class="text-sm text-gray-300 mt-2">ูโุชูุงูุฏ ุจู ุฏูุจุงู ุดุบู ููุงุณุจ ุจุงุดุฏ ุง ุฏุฑ ุฑุดุชู ุฏฺฏุฑ ุงุฏุงูู ุชุญุตู ุฏูุฏ.</p>
              ${gameState.education.major ? `<p><strong>ูุฏุฑฺฉ:</strong> ${gameState.education.major}</p>` : ''}
            </div>
          `;
        } else {
          // Ready to choose major
          htmlContent = `
            <div class="glass-card p-4">
              <h3 class="text-lg font-semibold mb-2">ุงูุชุฎุงุจ ุฑุดุชู ุฏุงูุดฺฏุงู</h3>
              <p class="text-sm text-gray-300 mb-4">ุฑุดุชูโุง ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ ฺฉู ุจู ุนูุงูู ู ุชูุงูุงโูุง ุดูุง ูุฒุฏฺฉ ุจุงุดุฏ.</p>
              <select id="major-select" class="w-full p-3 mb-4 text-right bg-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <option value="ูพุฒุดฺฉ">ูพุฒุดฺฉ (ูุงุฒ ุจู ููุด ุจุงูุง: ทฐ+)</option>
                <option value="ูููุฏุณ">ูููุฏุณ (ูุงุฒ ุจู ููุด ูุชูุณุท: ถฐ+)</option>
                <option value="ุญููู">ุญููู (ูุงุฒ ุจู ููุด ูุชูุณุท: ถฐ+)</option>
                <option value="ููุฑ">ููุฑ (ูุงุฒ ุจู ุธุงูุฑ: ตฐ+ุ ุดุงุฏ: ตฐ+)</option>
                <option value="ูุฏุฑุช">ูุฏุฑุช</option>
              </select>
              <button class="btn-primary w-full py-3 rounded-lg" onclick="window.applyUniversity()">ุซุจุชโูุงู ุฏุฑ ุฏุงูุดฺฏุงู</button>
            </div>
          `;
        }
      }
      content.innerHTML = htmlContent;
    }

    // Function for studying in school (ุชุงุจุน ุจุฑุง ุฏุฑุณ ุฎูุงูุฏู ุฏุฑ ูุฏุฑุณู)
    window.study = function(level) {
      // Logic for studying remains mostly the same, just update UI based on new structure
      gameState.smarts = Math.min(100, gameState.smarts + 5);
      let logMessage = '';
      if (level === 'primary') {
        gameState.education.level = 'ุงุจุชุฏุง';
        logMessage = 'ุดูุง ุฏุฑ ุฏุจุณุชุงู ุฏุฑุณ ุฎูุงูุฏุฏ.';
      } else if (level === 'middle') {
        gameState.education.level = 'ุฑุงูููุง';
        logMessage = 'ุดูุง ุฏุฑ ุฑุงูููุง ุฏุฑุณ ุฎูุงูุฏุฏ.';
      } else if (level === 'high') {
        gameState.education.level = 'ุฏุจุฑุณุชุงู';
        logMessage = 'ุดูุง ุฏุฑ ุฏุจุฑุณุชุงู ุฏุฑุณ ุฎูุงูุฏุฏ.';
      } else if (level === 'general') {
        logMessage = 'ุดูุง ูุทุงูุนู ุขุฒุงุฏ ุฏุงุดุชุฏ ู ููุด ุดูุง ุงูุฒุงุด ุงูุช.';
        gameState.smarts = Math.min(100, gameState.smarts + 3); // Slightly less for general (ฺฉู ฺฉูุชุฑ ุจุฑุง ุนููู)
      }
      gameState.log.push({ year: gameState.year, event: logMessage, type: 'education' });
      updateUI();
      window.showSchool(); // Re-render school page (ุจุงุฒุณุงุฒ ุตูุญู ูุฏุฑุณู)
      saveGame();
    }

    // Function for continuing university study (ุชุงุจุน ุจุฑุง ุงุฏุงูู ุชุญุตู ุฏุฑ ุฏุงูุดฺฏุงู)
    window.continueUniversityStudy = function() {
        if (gameState.education.level !== 'ุฏุงูุดฺฏุงู') {
            showMessageModal('ุดูุง ุฏุฑ ุญุงู ุญุงุถุฑ ุฏุงูุดุฌู ุฏุงูุดฺฏุงู ูุณุชุฏ.');
            return;
        }

        gameState.education.degreeProgress += 10 + Math.floor(Math.random() * 10); // 10-20% progress (ฑฐ-ฒฐูช ูพุดุฑูุช)
        if (gameState.education.degreeProgress >= 100) {
            gameState.education.degreeProgress = 100;
            gameState.education.level = `ูุงุฑุบโุงูุชุญุตู ${gameState.education.major}`;
            gameState.log.push({ year: gameState.year, event: `ุดูุง ุงุฒ ุฏุงูุดฺฏุงู ุฏุฑ ุฑุดุชู ${gameState.education.major} ูุงุฑุบโุงูุชุญุตู ุดุฏุฏ!`, type: 'education' });
            showMessageModal(`ุชุจุฑฺฉ! ุดูุง ุงุฒ ุฏุงูุดฺฏุงู ุฏุฑ ุฑุดุชู ${gameState.education.major} ูุงุฑุบโุงูุชุญุตู ุดุฏุฏ.`);
        } else {
            gameState.log.push({ year: gameState.year, event: `ุดูุง ุฏุฑ ุญุงู ุชุญุตู ุฏุฑ ุฑุดุชู ${gameState.education.major} ูุณุชุฏ. (${gameState.education.degreeProgress}% ูพุดุฑูุช)`, type: 'education' });
        }
        gameState.smarts = Math.min(100, gameState.smarts + 7); // Boost smarts (ุงูุฒุงุด ููุด)
        updateUI();
        window.showUniversity(); // Re-render university page (ุจุงุฒุณุงุฒ ุตูุญู ุฏุงูุดฺฏุงู)
        saveGame();
    }

    window.applyUniversity = function() {
      if (gameState.age < 18 || !(gameState.education.level.includes('ุฏุจุฑุณุชุงู') || gameState.education.level.includes('ูุงุฑุบโุงูุชุญุตู'))) {
        showMessageModal('ุจุฑุง ูุฑูุฏ ุจู ุฏุงูุดฺฏุงู ุจุงุฏ ุญุฏุงูู ฑธ ุณุงู ุฏุงุดุชู ุจุงุดุฏ ู ุฏุจุฑุณุชุงู ุฑุง ุชูุงู ฺฉุฑุฏู ุจุงุดุฏ.');
        return;
      }
      const selectedMajor = document.getElementById('major-select').value;
      
      // Check requirements for majors (ุจุฑุฑุณ ุงูุฒุงูุงุช ุจุฑุง ุฑุดุชูโูุง)
      if (selectedMajor === 'ูพุฒุดฺฉ' && gameState.smarts < 70) {
        showMessageModal('ููุด ุดูุง ุจุฑุง ุฑุดุชู ูพุฒุดฺฉ ฺฉุงู ูุณุช. (ูุงุฒ ุจู ููุด ทฐ)');
        return;
      }
      if ((selectedMajor === 'ูููุฏุณ' || selectedMajor === 'ุญููู') && gameState.smarts < 60) {
        showMessageModal('ููุด ุดูุง ุจุฑุง ุงู ุฑุดุชู ฺฉุงู ูุณุช. (ูุงุฒ ุจู ููุด ถฐ)');
        return;
      }
      if (selectedMajor === 'ููุฑ' && (gameState.looks < 50 || gameState.happiness < 50)) {
        showMessageModal('ุจุฑุง ุฑุดุชู ููุฑ ูุงุฒ ุจู ุธุงูุฑ ู ุดุงุฏ ุจุดุชุฑ ุฏุงุฑุฏ. (ูุงุฒ ุจู ุธุงูุฑ ตฐ ู ุดุงุฏ ตฐ)');
        return;
      }

      gameState.education.level = 'ุฏุงูุดฺฏุงู';
      gameState.education.major = selectedMajor;
      gameState.education.degreeProgress = 0; // Reset progress (ูพุดุฑูุช ุฑุง ุจุงุฒูุดุงู ูโฺฉูุฏ)
      gameState.log.push({ year: gameState.year, event: `ุดูุง ุฏุฑ ุฑุดุชู ${selectedMajor} ุฏุฑ ุฏุงูุดฺฏุงู ุซุจุชโูุงู ฺฉุฑุฏุฏ.`, type: 'education' });
      updateUI();
      window.showUniversity(); // Re-render university page (ุจุงุฒุณุงุฒ ุตูุญู ุฏุงูุดฺฏุงู)
      saveGame();
    }

    window.dropOut = function() {
        if (gameState.education.level !== 'ุฏุงูุดฺฏุงู') {
            showMessageModal('ุดูุง ุฏุฑ ุญุงู ุญุงุถุฑ ุฏุงูุดุฌู ุฏุงูุดฺฏุงู ูุณุชุฏ.');
            return;
        }
        window.confirm('ุขุง ูุทูุฆู ูุณุชุฏ ฺฉู ูโุฎูุงูุฏ ุงุฒ ุฏุงูุดฺฏุงู ุงูุตุฑุงู ุฏูุฏุ ุงู ฺฉุงุฑ ููฺฉู ุงุณุช ุจุฑ ุขูุฏู ุดุบู ุดูุง ุชุฃุซุฑ ุจฺฏุฐุงุฑุฏ.').then(confirmed => {
            if (confirmed) {
                gameState.education.level = 'ูุงุฑุบโุงูุชุญุตู ุฏุจุฑุณุชุงู'; // Changed to this to reflect reality (ุจู ุงู ุชุบุฑ ุงูุช ุชุง ูุงูุนุช ุฑุง ููุนุงฺฉุณ ฺฉูุฏ)
                gameState.education.major = '';
                gameState.education.degreeProgress = 0;
                gameState.log.push({ year: gameState.year, event: 'ุดูุง ุงุฒ ุฏุงูุดฺฏุงู ุงูุตุฑุงู ุฏุงุฏุฏ.', type: 'education' });
                showMessageModal('ุดูุง ุงุฒ ุฏุงูุดฺฏุงู ุงูุตุฑุงู ุฏุงุฏุฏ.');
                updateUI();
                window.showUniversity(); // Re-render university page (ุจุงุฒุณุงุฒ ุตูุญู ุฏุงูุดฺฏุงู)
                saveGame();
            }
        });
    }

    // Relationships (ุฑูุงุจุท)
    window.interact = function(personId, action) {
      const person = gameState.relationships.find(r => r.id === personId);
      if (!person) return;

      if (action === 'talk') {
        person.relationship = Math.min(100, person.relationship + 5);
        gameState.happiness = Math.min(100, gameState.happiness + 3);
        gameState.log.push({ year: gameState.year, event: `ุดูุง ุจุง ${person.name} ุตุญุจุช ฺฉุฑุฏุฏ.`, type: 'family' });
      } else if (action === 'gift') {
        const giftCost = 100000;
        if (gameState.money < giftCost) {
          showMessageModal(`ูพูู ฺฉุงู ุจุฑุง ุฎุฑุฏ ูุฏู ูุฏุงุฑุฏ! (ุญุฏุงูู ${giftCost.toLocaleString('fa-IR')} ุชููุงู)`);
          return;
        }
        gameState.money -= giftCost;
        person.relationship = Math.min(100, person.relationship + 10);
        gameState.log.push({ year: gameState.year, event: `ุดูุง ุจู ${person.name} ูุฏู ุฏุงุฏุฏ.`, type: 'family' });
      } else if (action === 'argue') {
        person.relationship = Math.max(0, person.relationship - 15);
        gameState.happiness = Math.max(0, gameState.happiness - 5);
        gameState.log.push({ year: gameState.year, event: `ุดูุง ุจุง ${person.name} ุฏุนูุง ฺฉุฑุฏุฏ.`, type: 'family' });
      }
      updateUI();
      saveGame();
    }

    // Romantic Relationships (ุฑูุงุจุท ุนุงุทู)
    window.findPartner = function() {
        if (gameState.age < 18) {
            showMessageModal('ุดูุง ุจุฑุง ูพุฏุง ฺฉุฑุฏู ุดุฑฺฉ ุนุงุทู ุฎู ฺฉูฺฺฉ ูุณุชุฏ.');
            return;
        }
        if (gameState.romanticRelationships.length > 0 && gameState.romanticRelationships[0].isMarried) {
            showMessageModal('ุดูุง ุฏุฑ ุญุงู ุญุงุถุฑ ูุชุงูู ูุณุชุฏ ู ููโุชูุงูุฏ ุดุฑฺฉ ุนุงุทู ุฌุฏุฏ ูพุฏุง ฺฉูุฏ.');
            return;
        }
        
        const chance = (gameState.looks + gameState.happiness) / 200; // Chance based on looks and happiness (ุดุงูุณ ุจุฑ ุงุณุงุณ ุธุงูุฑ ู ุดุงุฏ)
        if (Math.random() < chance) {
            const partnerName = gameState.gender === 'male' ? 'ุฎุงูู' : 'ุขูุง'; // Simple naming (ูุงูฺฏุฐุงุฑ ุณุงุฏู)
            const newPartner = {
                id: crypto.randomUUID(),
                name: `${partnerName} ุฌุฏุฏ`,
                role: 'ุดุฑฺฉ ุนุงุทู',
                relationship: 30 + Math.floor(Math.random() * 20), // Initial relationship (ุฑุงุจุทู ุงููู)
                isMarried: false,
                age: gameState.age + (Math.random() * 5 - 2) // Partner age close to player's (ุณู ุดุฑฺฉ ูุฒุฏฺฉ ุจู ุจุงุฒฺฉู)
            };
            gameState.romanticRelationships.push(newPartner);
            gameState.log.push({ year: gameState.year, event: `ุดูุง ุจุง ${newPartner.name} ุขุดูุง ุดุฏุฏ!`, type: 'family' });
            showMessageModal(`ุชุจุฑฺฉ! ุดูุง ุจุง ${newPartner.name} ุขุดูุง ุดุฏุฏ.`);
        } else {
            gameState.log.push({ year: gameState.year, event: 'ุชูุงุด ุจุฑุง ูพุฏุง ฺฉุฑุฏู ุดุฑฺฉ ุนุงุทู ูุงูููู ุจูุฏ.', type: 'family' });
            showMessageModal('ูุชุงุณูุงูู ุฏุฑ ุงู ุณุงู ุดุฑฺฉ ุนุงุทู ูพุฏุง ูฺฉุฑุฏุฏ.');
        }
        updateUI();
        saveGame();
    }

    window.interactRomantic = function(personId, action) {
        const partner = gameState.romanticRelationships.find(r => r.id === personId);
        if (!partner) return;

        if (action === 'talk') {
            partner.relationship = Math.min(100, partner.relationship + 7);
            gameState.happiness = Math.min(100, gameState.happiness + 5);
            gameState.log.push({ year: gameState.year, event: `ุดูุง ุจุง ${partner.name} ุตุญุจุช ุนูู ุฏุงุดุชุฏ.`, type: 'family' });
        } else if (action === 'date') {
            const dateCost = 500000;
            if (gameState.money < dateCost) {
                showMessageModal(`ูพูู ฺฉุงู ุจุฑุง ูุฑุงุฑ ููุงูุงุช ูุฏุงุฑุฏ! (ุญุฏุงูู ${dateCost.toLocaleString('fa-IR')} ุชููุงู)`);
                return;
            }
            gameState.money -= dateCost;
            partner.relationship = Math.min(100, partner.relationship + 15);
            gameState.happiness = Math.min(100, gameState.happiness + 10);
            gameState.log.push({ year: gameState.year, event: `ุดูุง ุจุง ${partner.name} ุจู ูุฑุงุฑ ููุงูุงุช ุฑูุชุฏ.`, type: 'family' });
        }
        updateUI();
        saveGame();
    }

    window.proposeMarriage = function(personId) {
        const partner = gameState.romanticRelationships.find(r => r.id === personId);
        if (!partner || partner.isMarried) return;

        if (partner.relationship < 80) {
            showMessageModal('ุฑุงุจุทู ุดูุง ุจุง ุงู ุดุฎุต ุจู ุงูุฏุงุฒู ฺฉุงู ูู ูุณุช ฺฉู ุงุฒุฏูุงุฌ ฺฉูุฏ. (ูุงุฒ ุจู ุฑุงุจุทู ธฐูช+)');
            return;
        }

        const marriageCost = 5000000; // Example marriage cost (ูุฒูู ุงุฒุฏูุงุฌ)
        if (gameState.money < marriageCost) {
            showMessageModal(`ูพูู ฺฉุงู ุจุฑุง ูุฑุงุณู ุงุฒุฏูุงุฌ ูุฏุงุฑุฏ! (ุญุฏุงูู ${marriageCost.toLocaleString('fa-IR')} ุชููุงู)`);
            return;
        }

        const success = Math.random() < (partner.relationship / 100);
        if (success) {
            partner.role = 'ููุณุฑ';
            partner.isMarried = true;
            gameState.money -= marriageCost; // Deduct marriage cost (ฺฉุณุฑ ูุฒูู ุงุฒุฏูุงุฌ)
            gameState.happiness = Math.min(100, gameState.happiness + 20);
            gameState.log.push({ year: gameState.year, event: `ุดูุง ุจุง ${partner.name} ุงุฒุฏูุงุฌ ฺฉุฑุฏุฏ! ุชุจุฑฺฉ!`, type: 'family' });
            showMessageModal(`ุชุจุฑฺฉ! ุดูุง ุจุง ${partner.name} ุงุฒุฏูุงุฌ ฺฉุฑุฏุฏ.`);
        } else {
            partner.relationship = Math.max(0, partner.relationship - 20); // Relationship hit (ุถุฑุจู ุจู ุฑุงุจุทู)
            gameState.happiness = Math.max(0, gameState.happiness - 10); // Happiness hit (ุถุฑุจู ุจู ุดุงุฏ)
            gameState.log.push({ year: gameState.year, event: `ูพุดููุงุฏ ุงุฒุฏูุงุฌ ุดูุง ุจู ${partner.name} ุฑุฏ ุดุฏ.`, type: 'family' });
            showMessageModal(`ูุชุงุณูุงูู ${partner.name} ูพุดููุงุฏ ุงุฒุฏูุงุฌ ุดูุง ุฑุง ุฑุฏ ฺฉุฑุฏ.`);
        }
        updateUI();
        saveGame();
    }

    window.tryForBaby = function(personId) {
      const partner = gameState.romanticRelationships.find(r => r.id === personId);
      if (!partner || !partner.isMarried) {
        showMessageModal('ุดูุง ุจุงุฏ ูุชุงูู ุจุงุดุฏ ุชุง ุจฺูโุฏุงุฑ ุดูุฏ.');
        return;
      }
      if (gameState.age < 20 || gameState.age > 45) { // Realistic age range (ูุญุฏูุฏู ุณู ูุงูุนโุจูุงูู)
        showMessageModal('ุดูุง ุฏุฑ ูุญุฏูุฏู ุณู ููุงุณุจ ุจุฑุง ุจฺูโุฏุงุฑ ุดุฏู ูุณุชุฏ. (ฒฐ ุชุง ดต ุณุงูฺฏ)');
        return;
      }
      
      const successChance = (gameState.health / 100) * (partner.relationship / 100); // Health and relationship affect chance (ุณูุงูุช ู ุฑุงุจุทู ุจุฑ ุดุงูุณ ุชุฃุซุฑ ูโฺฏุฐุงุฑุฏ)
      if (Math.random() < successChance) {
        const babyName = gameState.gender === 'male' ? 'ุฏุฎุชุฑ' : 'ูพุณุฑ'; // Simple naming (ูุงูฺฏุฐุงุฑ ุณุงุฏู)
        const newChild = {
          id: crypto.randomUUID(),
          name: `${babyName} ุดูุง`,
          age: 0,
          relationship: 70 + Math.floor(Math.random() * 10), // Initial relationship (ุฑุงุจุทู ุงููู)
          role: 'ูุฑุฒูุฏ' // Add role for children (ุงูุฒูุฏู ููุด ุจุฑุง ูุฑุฒูุฏุงู)
        };
        gameState.children.push(newChild);
        gameState.relationships.push(newChild); // Add children to main relationships array (ุงูุฒูุฏู ูุฑุฒูุฏุงู ุจู ุขุฑุงู ุงุตู ุฑูุงุจุท)
        gameState.happiness = Math.min(100, gameState.happiness + 30);
        gameState.log.push({ year: gameState.year, event: `ุชุจุฑฺฉ! ุดูุง ุตุงุญุจ ฺฉ ${newChild.name} ุดุฏ!`, type: 'family' });
        showMessageModal(`ุชุจุฑฺฉ! ุดูุง ุตุงุญุจ ฺฉ ${newChild.name} ุดุฏุฏ!`);
      } else {
        gameState.log.push({ year: gameState.year, event: 'ุชูุงุด ุจุฑุง ุจฺูโุฏุงุฑ ุดุฏู ููููุช ุขูุฒ ูุจูุฏ.', type: 'family' });
        showMessageModal('ุชูุงุด ุจุฑุง ุจฺูโุฏุงุฑ ุดุฏู ููููุชโุขูุฒ ูุจูุฏ. ุฏูุจุงุฑู ุงูุชุญุงู ฺฉูุฏ.');
      }
      updateUI();
      saveGame();
    }

    window.breakup = function(personId) {
        window.confirm('ุขุง ูุทูุฆู ูุณุชุฏ ฺฉู ูโุฎูุงูุฏ ุงู ุฑุงุจุทู ุฑุง ุชูุงู ฺฉูุฏุ').then(confirmed => {
            if (confirmed) {
                gameState.romanticRelationships = gameState.romanticRelationships.filter(r => r.id !== personId);
                gameState.happiness = Math.max(0, gameState.happiness - 25);
                gameState.log.push({ year: gameState.year, event: 'ุดูุง ฺฉ ุฑุงุจุทู ุนุงุทู ุฑุง ุจู ูพุงุงู ุฑุณุงูุฏุฏ.', type: 'family' });
                showMessageModal('ุฑุงุจุทู ุดูุง ุจู ูพุงุงู ุฑุณุฏ.');
                updateUI();
                saveGame();
            }
        });
    }


    // Health (ุณูุงูุช)
    const illnessesData = {
        'ุณุฑูุงุฎูุฑุฏฺฏ': { severity: 'ุฎูู', impact: 10, cost: 50000, specialist: false },
        'ุขููููุงูุฒุง': { severity: 'ูุชูุณุท', impact: 20, cost: 150000, specialist: false },
        'ุขูพุงูุฏุณุช': { severity: 'ุฌุฏ', impact: 40, cost: 1000000, specialist: true },
        'ุงูุณุฑุฏฺฏ': { severity: 'ูุฒูู', impact: 15, cost: 200000, specialist: true }
    };

    function visitDoctor() {
      const cost = 50000;
      if (gameState.money < cost) {
        showMessageModal(`ูพูู ฺฉุงู ุจุฑุง ูุฑุงุฌุนู ุจู ูพุฒุดฺฉ ูุฏุงุฑุฏ! (ูุฒูู: ${cost.toLocaleString('fa-IR')} ุชููุงู)`);
        return;
      }
      gameState.money -= cost;
      gameState.health = Math.min(100, gameState.health + 20);
      gameState.illnesses = gameState.illnesses.filter(ill => illnessesData[ill.name]?.specialist === false); // Only minor illnesses cured (ููุท ุจูุงุฑโูุง ุฌุฒุฆ ุฏุฑูุงู ูโุดููุฏ)
      gameState.log.push({ year: gameState.year, event: 'ุดูุง ุจู ูพุฒุดฺฉ ุนููู ูุฑุงุฌุนู ฺฉุฑุฏุฏ ู ุญุงูุชุงู ุจูุชุฑ ุดุฏ.', type: 'health' });
      updateUI();
      saveGame();
    }

    function visitSpecialist() {
        const cost = 500000;
        if (gameState.money < cost) {
            showMessageModal(`ูพูู ฺฉุงู ุจุฑุง ูุฑุงุฌุนู ุจู ูุชุฎุตุต ูุฏุงุฑุฏ! (ูุฒูู: ${cost.toLocaleString('fa-IR')} ุชููุงู)`);
            return;
        }
        if (gameState.illnesses.length === 0) {
            showMessageModal('ุดูุง ูฺ ุจูุงุฑ ุฎุงุต ูุฏุงุฑุฏ ฺฉู ูุงุฒ ุจู ูุชุฎุตุต ุฏุงุดุชู ุจุงุดุฏ.');
            return;
        }

        gameState.money -= cost;
        gameState.health = Math.min(100, gameState.health + 40);
        gameState.illnesses = []; // Clear all illnesses (ุชูุงู ุจูุงุฑโูุง ุฑุง ูพุงฺฉ ูโฺฉูุฏ)
        gameState.log.push({ year: gameState.year, event: 'ุดูุง ุจู ูุชุฎุตุต ูุฑุงุฌุนู ฺฉุฑุฏุฏ ู ุจูุจูุฏ ฺฉุงูู ุงูุชุฏ.', type: 'health' });
        showMessageModal('ุจูุงุฑโูุง ุดูุง ุชูุณุท ูุชุฎุตุต ุฏุฑูุงู ุดุฏ.');
        updateUI();
        saveGame();
    }

    function goGym() {
      const cost = 20000;
      if (gameState.money < cost) {
        showMessageModal(`ูพูู ฺฉุงู ุจุฑุง ุฑูุชู ุจู ุจุงุดฺฏุงู ูุฏุงุฑุฏ! (ูุฒูู: ${cost.toLocaleString('fa-IR')} ุชููุงู)`);
        return;
      }
      gameState.money -= cost;
      gameState.health = Math.min(100, gameState.health + 10);
      gameState.looks = Math.min(100, gameState.looks + 5);
      gameState.log.push({ year: gameState.year, event: 'ุดูุง ูุฑุฒุด ฺฉุฑุฏุฏ ู ุณุงููโุชุฑ ุดุฏุฏ.', type: 'health' });
      updateUI();
      saveGame();
    }

    function meditate() {
      gameState.spirituality = Math.min(100, gameState.spirituality + 10);
      gameState.happiness = Math.min(100, gameState.happiness + 5);
      gameState.log.push({ year: gameState.year, event: 'ุดูุง ูุฑุงูุจู ฺฉุฑุฏุฏ ู ุขุฑุงูุด ุจุดุชุฑ ุงูุชุฏ.', type: 'spirituality' });
      updateUI();
      saveGame();
    }

    // Asset Categories Data (ุฏุงุฏูโูุง ุฏุณุชูโุจูุฏ ุฏุงุฑุงโูุง)
    const assetCategories = {
      'properties': {
        name: 'ุงููุงฺฉ',
        emoji: '๐',
        items: [
          { name: 'ุฎุงููโ ููุง', basePrice: 250000000 },
          { name: 'ุขูพุงุฑุชูุงู ุดูุฑ', basePrice: 150000000 },
          { name: 'ูุฒุฑุนู', basePrice: 400000000 },
          { name: 'ููุง ุฏุฑ ุดูุงู', basePrice: 700000000 },
          { name: 'ุฌุฒุฑู ุฎุตูุต', basePrice: 5000000000 }
        ]
      },
      'vehicles': {
        name: 'ุฎูุฏุฑููุง',
        emoji: '๐',
        items: [
          { name: 'ูพุฑุงุฏ', basePrice: 80000000 },
          { name: 'ูพฺู ฒฐถ', basePrice: 450000000 },
          { name: 'ุจโุงูโู X6', basePrice: 3000000000 },
          { name: 'ูุงูุจูุฑฺฏู ุงููุชุงุฏูุฑ', basePrice: 15000000000 },
          { name: 'ูุงูุช ูุณุงู', basePrice: 120000000 }
        ]
      },
      'plane_boat': {
        name: 'ููุงูพูุง/ูุงู',
        emoji: 'โ๏ธ/โต',
        items: [
          { name: 'ูุงู ููุชูุฑ', basePrice: 600000000 },
          { name: 'ฺฉุดุช ุชูุฑุญ', basePrice: 8000000000 },
          { name: 'ููุงูพูุง ุดุฎุต', basePrice: 25000000000 },
          { name: 'ฺฏูุงุฏุฑ', basePrice: 1000000000 },
          { name: 'ูุงู ุจุงุฏ', basePrice: 5000000 }
        ]
      },
      'jewelry': {
        name: 'ุฌูุงูุฑุงุช',
        emoji: '๐',
        items: [
          { name: 'ุญููู ุทูุง', basePrice: 20000000 },
          { name: 'ฺฏุฑุฏูุจูุฏ ุฒูุฑุฏ', basePrice: 80000000 },
          { name: 'ุณุงุนุช ุฑููฺฉุณ', basePrice: 150000000 },
          { name: 'ุฏุณุชุจูุฏ ุทูุง', basePrice: 30000000 },
          { name: 'ฺฏูุดูุงุฑู ุงููุงุณ', basePrice: 300000000 }
        ]
      },
      'instruments': {
        name: 'ุณุงุฒูุง',
        emoji: '๐ธ',
        items: [
          { name: 'ฺฏุชุงุฑ ฺฉูุงุณฺฉ', basePrice: 10000000 },
          { name: 'ูพุงูู ุฏุฌุชุงู', basePrice: 80000000 },
          { name: 'ูููู', basePrice: 40000000 },
          { name: 'ุฏู ุงุฑุงู', basePrice: 5000000 },
          { name: 'ุณูุชูุฑ', basePrice: 30000000 }
        ]
      },
    };

    // New Investment Categories Data (ุฏุงุฏูโูุง ุฏุณุชูโุจูุฏ ุณุฑูุงูโฺฏุฐุงุฑ ุฌุฏุฏ)
    const investmentCategories = {
      'gold_coins': {
        name: 'ุทูุง ู ุณฺฉู',
        emoji: '๐ฐ',
        items: [
          { name: 'ฺฉ ฺฏุฑู ุทูุง ฑธ ุนุงุฑ', basePrice: 3500000, minGrowth: 0.05, maxGrowth: 0.15 },
          { name: 'ูู ุณฺฉู ุจูุงุฑ ุขุฒุงุฏ', basePrice: 20000000, minGrowth: 0.08, maxGrowth: 0.18 },
          { name: 'ุชูุงู ุณฺฉู ุจูุงุฑ ุขุฒุงุฏ', basePrice: 40000000, minGrowth: 0.10, maxGrowth: 0.20 }
        ]
      },
      'stocks_bourse': {
        name: 'ุณูุงู ุจูุฑุณ',
        emoji: '๐',
        items: [
          { name: 'ุณูุงู ุดุฑฺฉุช ุฎูุฏุฑู ุณุงุฒ', basePrice: 5000000, minGrowth: -0.05, maxGrowth: 0.25 },
          { name: 'ุณูุงู ุจุงูฺฉ', basePrice: 2000000, minGrowth: 0.02, maxGrowth: 0.10 },
          { name: 'ุตูุฏูู ุณุฑูุงูโฺฏุฐุงุฑ (ETF)', basePrice: 1000000, minGrowth: 0.07, maxGrowth: 0.17 }
        ]
      },
      'cryptocurrency': {
        name: 'ุงุฑุฒ ุฏุฌุชุงู',
        emoji: 'โฟ',
        items: [
          { name: 'ุจุชโฺฉูู (0.001 BTC)', basePrice: 50000000, minGrowth: -0.20, maxGrowth: 0.50 },
          { name: 'ุงุชุฑูู (0.01 ETH)', basePrice: 20000000, minGrowth: -0.15, maxGrowth: 0.40 },
          { name: 'ุชุชุฑ (100 USDT)', basePrice: 6000000, minGrowth: 0.001, maxGrowth: 0.005 } // Stablecoin, very low growth
        ]
      },
      'investment_land': {
        name: 'ุฒูู ู ุงููุงฺฉ (ุณุฑูุงูโฺฏุฐุงุฑ)',
        emoji: '๐ก',
        items: [
          { name: 'ูุทุนู ุฒูู ฺฉูฺฺฉ ุดูุฑ', basePrice: 500000000, minGrowth: 0.10, maxGrowth: 0.20 },
          { name: 'ุฒูู ฺฉุดุงูุฑุฒ', basePrice: 1000000000, minGrowth: 0.07, maxGrowth: 0.15 },
          { name: 'ููฺฉ ุชุฌุงุฑ ฺฉูฺฺฉ', basePrice: 2000000000, minGrowth: 0.12, maxGrowth: 0.25 }
        ]
      },
      'raw_materials': {
        name: 'ููุงุฏ ุงููู',
        emoji: '๐ฆ',
        items: [
          { name: 'ฑฐฐ ฺฉููฺฏุฑู ฺฏูุฏู', basePrice: 500000, minGrowth: -0.08, maxGrowth: 0.10 },
          { name: 'ฑ ุชู ุณูุงู', basePrice: 1500000, minGrowth: 0.01, maxGrowth: 0.08 },
          { name: 'ฑฐฐ ูุชุฑ ููุช ุฎุงู', basePrice: 3000000, minGrowth: -0.10, maxGrowth: 0.15 }
        ]
      }
    };


    // Helper function to calculate fluctuating market price (ุชุงุจุน ฺฉูฺฉ ุจุฑุง ูุญุงุณุจู ููุช ููุณุงู ุจุงุฒุงุฑ)
    function calculateMarketPrice(basePrice) {
        const fluctuation = (Math.random() * 0.2) - 0.1; // -10% to +10% (ฑฐูช- ุชุง ฑฐูช+)
        return Math.floor(basePrice * (1 + fluctuation));
    }

    // Function to show a specific asset category page (ุชุงุจุน ุจุฑุง ููุงุด ุตูุญู ูุฎุตูุต ุฏุณุชูโุจูุฏ ุฏุงุฑุง)
    window.showAssetCategoryPage = function(type) {
      const category = assetCategories[type];
      if (!category) {
        console.error('Invalid asset category type:', type);
        showMessageModal('ุฎุทุง: ุฏุณุชู ุฏุงุฑุง ูุงูุนุชุจุฑ ุงุณุช.');
        return;
      }

      // First, show the page. This ensures the H2 element is potentially ready.
      window.showPage(`${type}-page`); 

      // Now update the page title (ุจูโุฑูุฒุฑุณุงู ุนููุงู ุตูุญู)
      // This line is now called AFTER the page is set to display: block
      const pageH2 = document.querySelector(`#${type}-page h2`);
      if (pageH2) { // Add a null check for robustness
        pageH2.textContent = `${category.emoji} ${category.name}`;
      } else {
        console.error(`Could not find h2 for page: ${type}-page`);
      }

      // Populate owned items (ูพุฑ ฺฉุฑุฏู ุขุชูโูุง ููุฌูุฏ)
      const ownedListId = `owned-${type}-list`;
      const ownedListElement = document.getElementById(ownedListId);
      const ownedAssets = gameState.assets.filter(a => a.type === type);
      ownedListElement.innerHTML = ownedAssets.map(asset => `
        <div class="glass-card p-3 flex justify-between items-center">
          <span>${asset.name} - ${asset.value.toLocaleString('fa-IR')} ุชููุงู</span>
          <button class="btn-secondary px-3 py-1 rounded-lg text-xs" onclick="window.sellAsset('${asset.id}', '${type}')">ูุฑูุด</button>
        </div>
      `).join('') || '<p class="text-gray-400">ุดูุง ูฺ ุฏุงุฑุง ุฏุฑ ุงู ุฏุณุชู ูุฏุงุฑุฏ.</p>';

      // Populate items for sale (ูพุฑ ฺฉุฑุฏู ุขุชูโูุง ุจุฑุง ูุฑูุด)
      const buyListId = `buy-${type}-list`;
      const buyListElement = document.getElementById(buyListId);
      buyListElement.innerHTML = category.items.map(item => {
        const currentPrice = calculateMarketPrice(item.basePrice);
        const priceDifference = ((currentPrice - item.basePrice) / item.basePrice * 100).toFixed(1);
        const priceColorClass = priceDifference >= 0 ? 'text-red-400' : 'text-green-400';
        const priceSign = priceDifference >= 0 ? '+' : ''; // Add plus sign for positive changes (ุงูุฒูุฏู ุนูุงูุช ูุซุจุช ุจุฑุง ุชุบุฑุงุช ูุซุจุช)

        return `
          <div class="glass-card p-4 flex flex-col sm:flex-row justify-between items-center">
            <div>
              <p class="font-semibold">${item.name}</p>
              <p class="text-sm text-gray-400">ููุช: ${currentPrice.toLocaleString('fa-IR')} ุชููุงู</p>
              <p class="text-xs ${priceColorClass}">(${priceSign}${priceDifference}%)</p>
            </div>
            <button class="btn-primary px-4 py-2 rounded-lg mt-2 sm:mt-0" onclick="window.buyAsset('${type}', '${item.name}', ${currentPrice})">ุฎุฑุฏ</button>
          </div>
        `;
      }).join('');

    };

    // Buy asset function (ุชุงุจุน ุฎุฑุฏ ุฏุงุฑุง)
    window.buyAsset = function(assetType, assetName, assetPrice) {
      if (gameState.money < assetPrice) {
        showMessageModal(`ูพูู ฺฉุงู ุจุฑุง ุฎุฑุฏ ${assetName} ูุฏุงุฑุฏ! (ูุงุฒ ุจู ${assetPrice.toLocaleString('fa-IR')} ุชููุงู)`);
        return;
      }

      gameState.money -= assetPrice;
      gameState.assets.push({ id: crypto.randomUUID(), type: assetType, name: assetName, value: assetPrice });
      gameState.log.push({ year: gameState.year, event: `ุดูุง ${assetName} ุฑุง ุจู ูุจูุบ ${assetPrice.toLocaleString('fa-IR')} ุชููุงู ุฎุฑุฏุฏ.`, type: 'finance' });
      showMessageModal(`ุดูุง ${assetName} ุฑุง ุฎุฑุฏุฏ.`);
      updateUI();
      window.showAssetCategoryPage(assetType); // Refresh the current asset page to show changes (ุฑูุฑุด ุตูุญู ุฏุงุฑุง ูุนู ุจุฑุง ููุงุด ุชุบุฑุงุช)
      saveGame();
    };

    // Sell asset function (ุชุงุจุน ูุฑูุด ุฏุงุฑุง)
    window.sellAsset = function(assetId, assetType) {
      const assetIndex = gameState.assets.findIndex(a => a.id === assetId);
      if (assetIndex === -1) {
        showMessageModal('ุฏุงุฑุง ุงูุช ูุดุฏ.');
        return;
      }

      const asset = gameState.assets[assetIndex];
      const sellPrice = Math.floor(asset.value * 0.9); // Sell for 90% of value (ูุฑูุด ุจุง นฐูช ุงุฑุฒุด)
      gameState.money += sellPrice;
      gameState.assets.splice(assetIndex, 1); // Remove asset (ุญุฐู ุฏุงุฑุง)
      gameState.log.push({ year: gameState.year, event: `ุดูุง ${asset.name} ุฑุง ุจู ูุจูุบ ${sellPrice.toLocaleString('fa-IR')} ุชููุงู ูุฑูุฎุชุฏ.`, type: 'finance' });
      showMessageModal(`ุดูุง ${asset.name} ุฑุง ูุฑูุฎุชุฏ ู ${sellPrice.toLocaleString('fa-IR')} ุชููุงู ุฏุฑุงูุช ฺฉุฑุฏุฏ.`);
      updateUI();
      window.showAssetCategoryPage(assetType); // Refresh the current asset page to show changes (ุฑูุฑุด ุตูุญู ุฏุงุฑุง ูุนู ุจุฑุง ููุงุด ุชุบุฑุงุช)
      saveGame();
    }

    // --- Investment Specific Functions (ุชูุงุจุน ูุฑุจูุท ุจู ุณุฑูุงูโฺฏุฐุงุฑ) ---

    // Function to show a specific investment category page (ุชุงุจุน ุจุฑุง ููุงุด ุตูุญู ูุฎุตูุต ุฏุณุชูโุจูุฏ ุณุฑูุงูโฺฏุฐุงุฑ)
    window.showInvestmentCategoryPage = function(type) {
      const category = investmentCategories[type];
      if (!category) {
        console.error('Invalid investment category type:', type);
        showMessageModal('ุฎุทุง: ุฏุณุชู ุณุฑูุงูโฺฏุฐุงุฑ ูุงูุนุชุจุฑ ุงุณุช.');
        return;
      }

      // First, show the page.
      window.showPage(`${type}-page`); // This calls updateUI()

      // Now update the page title (ุจูโุฑูุฒุฑุณุงู ุนููุงู ุตูุญู)
      // This line is now called AFTER the page is set to display: block
      const pageH2 = document.querySelector(`#${type}-page h2`);
      if (pageH2) { // Add a null check for robustness
        pageH2.textContent = `${category.emoji} ${category.name}`;
      } else {
        console.error(`Could not find h2 for investment page: ${type}-page`);
      }

      // Populate owned investments (ูพุฑ ฺฉุฑุฏู ุณุฑูุงุงโฺฏุฐุงุฑโูุง ููุฌูุฏ)
      const ownedListId = `owned-${type}-list`;
      const ownedListElement = document.getElementById(ownedListId);
      const ownedInvestments = gameState.investments.filter(a => a.type === type);
      ownedListElement.innerHTML = ownedInvestments.map(investment => `
        <div class="glass-card p-3 flex justify-between items-center">
          <span>${investment.name} - ${investment.value.toLocaleString('fa-IR')} ุชููุงู (ุจุงุฒุฏู: ${(investment.growth * 100).toFixed(1)}%)</span>
          <button class="btn-secondary px-3 py-1 rounded-lg text-xs" onclick="window.sellInvestment('${investment.id}', '${type}')">ูุฑูุด</button>
        </div>
      `).join('') || '<p class="text-gray-400">ุดูุง ูฺ ุณุฑูุงูโฺฏุฐุงุฑ ุฏุฑ ุงู ุฏุณุชู ูุฏุงุฑุฏ.</p>';

      // Populate items for sale (ูพุฑ ฺฉุฑุฏู ุขุชูโูุง ุจุฑุง ูุฑูุด)
      const buyListId = `buy-${type}-list`;
      const buyListElement = document.getElementById(buyListId);
      buyListElement.innerHTML = category.items.map(item => {
        const currentPrice = calculateMarketPrice(item.basePrice); // Use generic market price calc for initial purchase
        const priceDifference = ((currentPrice - item.basePrice) / item.basePrice * 100).toFixed(1);
        const priceColorClass = priceDifference >= 0 ? 'text-red-400' : 'text-green-400';
        const priceSign = priceDifference >= 0 ? '+' : '';

        return `
          <div class="glass-card p-4 flex flex-col sm:flex-row justify-between items-center">
            <div>
              <p class="font-semibold">${item.name}</p>
              <p class="text-sm text-gray-400">ููุช: ${currentPrice.toLocaleString('fa-IR')} ุชููุงู</p>
              <p class="text-xs ${priceColorClass}">(${priceSign}${priceDifference}%)</p>
            </div>
            <button class="btn-primary px-4 py-2 rounded-lg mt-2 sm:mt-0" 
                    onclick="window.buyInvestment('${type}', '${item.name}', ${currentPrice}, ${item.minGrowth}, ${item.maxGrowth})">ุฎุฑุฏ</button>
          </div>
        `;
      }).join('');

    };

    // Buy investment function (ุชุงุจุน ุฎุฑุฏ ุณุฑูุงูโฺฏุฐุงุฑ)
    window.buyInvestment = function(investmentType, investmentName, investmentPrice, minGrowth, maxGrowth) {
      if (gameState.money < investmentPrice) {
        showMessageModal(`ูพูู ฺฉุงู ุจุฑุง ุฎุฑุฏ ${investmentName} ูุฏุงุฑุฏ! (ูุงุฒ ุจู ${investmentPrice.toLocaleString('fa-IR')} ุชููุงู)`);
        return;
      }

      gameState.money -= investmentPrice;
      const growthRate = minGrowth + (Math.random() * (maxGrowth - minGrowth)); // Random growth rate within bounds (ูุฑุฎ ุฑุดุฏ ุชุตุงุฏู ุฏุฑ ูุญุฏูุฏู)
      const categoryEmoji = investmentCategories[investmentType].emoji;

      gameState.investments.push({ id: crypto.randomUUID(), type: investmentType, name: investmentName, value: investmentPrice, growth: growthRate, emoji: categoryEmoji });
      gameState.log.push({ year: gameState.year, event: `ุดูุง ${investmentName} ุฑุง ุจู ูุจูุบ ${investmentPrice.toLocaleString('fa-IR')} ุชููุงู ุฎุฑุฏุฏ.`, type: 'finance' });
      showMessageModal(`ุดูุง ${investmentName} ุฑุง ุฎุฑุฏุฏ.`);
      updateUI();
      window.showInvestmentCategoryPage(investmentType); // Refresh the current investment page to show changes (ุฑูุฑุด ุตูุญู ุณุฑูุงูโฺฏุฐุงุฑ ูุนู ุจุฑุง ููุงุด ุชุบุฑุงุช)
      saveGame();
    };

    // Sell investment function (ุชุงุจุน ูุฑูุด ุณุฑูุงูโฺฏุฐุงุฑ)
    window.sellInvestment = function(investmentId, investmentType) {
      const investmentIndex = gameState.investments.findIndex(a => a.id === investmentId);
      if (investmentIndex === -1) {
        showMessageModal('ุณุฑูุงูโฺฏุฐุงุฑ ุงูุช ูุดุฏ.');
        return;
      }

      const investment = gameState.investments[investmentIndex];
      const sellPrice = Math.floor(investment.value * 0.9); // Sell for 90% of current value (ูุฑูุด ุจุง นฐูช ุงุฑุฒุด ูุนู)
      gameState.money += sellPrice;
      gameState.investments.splice(investmentIndex, 1); // Remove investment (ุญุฐู ุณุฑูุงูโฺฏุฐุงุฑ)
      gameState.log.push({ year: gameState.year, event: `ุดูุง ${investment.name} ุฑุง ุจู ูุจูุบ ${sellPrice.toLocaleString('fa-IR')} ุชููุงู ูุฑูุฎุชุฏ.`, type: 'finance' });
      showMessageModal(`ุดูุง ${investment.name} ุฑุง ูุฑูุฎุชุฏ ู ${sellPrice.toLocaleString('fa-IR')} ุชููุงู ุฏุฑุงูุช ฺฉุฑุฏุฏ.`);
      updateUI();
      window.showInvestmentCategoryPage(investmentType); // Refresh the current investment page to show changes (ุฑูุฑุด ุตูุญู ุณุฑูุงุงโฺฏุฐุงุฑ ูุนู ุจุฑุง ููุงุด ุชุบุฑุงุช)
      saveGame();
    }


    // Save Game (ุฐุฎุฑู ุจุงุฒ)
    function saveGame() {
      try {
        localStorage.setItem('iranianLifeSimState', JSON.stringify(gameState));
      } catch (e) {
        console.error('Error saving game to localStorage:', e);
        showMessageModal('ุฎุทุง ุฏุฑ ุฐุฎุฑู ุจุงุฒ! ููฺฉู ุงุณุช ุญุงูุธู ูุฑูุฑฺฏุฑ ุดูุง ูพุฑ ุจุงุดุฏ.');
      }
    }

    // Load Game (ุจุงุฑฺฏุฐุงุฑ ุจุงุฒ)
    function loadGame() {
      try {
        const savedState = localStorage.getItem('iranianLifeSimState');
        if (savedState) {
          gameState = JSON.parse(savedState);
          // Ensure financeHistory is an array and has at least one entry (ุงุทููุงู ุงุฒ ุงูฺฉู financeHistory ฺฉ ุขุฑุงู ุงุณุช ู ุญุฏุงูู ฺฉ ูุฑูุฏ ุฏุงุฑุฏ)
          if (!gameState.financeHistory || gameState.financeHistory.length === 0) {
              gameState.financeHistory = [{ year: gameState.year, money: gameState.money }];
          }
          updateUI();
          window.showPage('dashboard');
          showMessageModal('ุจุงุฒ ุจุงุฑฺฏุฐุงุฑ ุดุฏ!');
        } else {
          console.log('No saved game found in localStorage.');
          // If no saved game, stay on start screen (ุงฺฏุฑ ุจุงุฒ ุฐุฎุฑู ุดุฏูโุง ูุณุชุ ุฏุฑ ุตูุญู ุดุฑูุน ุจูุงูุฏ)
        }
      } catch (e) {
        console.error('Error loading game from localStorage:', e);
        showMessageModal('ุฎุทุง ุฏุฑ ุจุงุฑฺฏุฐุงุฑ ุจุงุฒ! ูุงู ุฐุฎุฑู ุดุฏู ููฺฉู ุงุณุช ุฎุฑุงุจ ุจุงุดุฏ.');
      }
    }

    // Reset Game (ุฑุณุช ุจุงุฒ)
    async function resetGame() {
      const confirmed = await window.confirm('ุขุง ูุทูุฆู ูุณุชุฏ ฺฉู ูโุฎูุงูุฏ ุจุงุฒ ุฑุง ุฑุณุช ฺฉูุฏุ ุชูุงู ูพุดุฑูุช ุดูุง ุงุฒ ุจู ุฎูุงูุฏ ุฑูุช.');
      if (confirmed) {
        try {
          localStorage.removeItem('iranianLifeSimState'); // Clear local storage (ุญุฐู ุงุฒ ุญุงูุธู ูุญู)
        } catch (e) {
          console.error('Error clearing game from localStorage:', e);
        }
        gameState = {
          name: '', gender: '', province: '', familyStatus: '', age: 0, year: 2025, money: 0,
          happiness: 50, health: 80, smarts: 50, looks: 50, spirituality: 50,
          education: { level: 'ูฺ', major: '', degreeProgress: 0 }, job: { title: 'ุจฺฉุงุฑ', salary: 0, level: 0, experience: 0 },
          relationships: [
            { id: 'parent1', name: 'ูพุฏุฑ', role: 'ูพุฏุฑ', relationship: 80, respect: 70, happiness: 60, age: 40 }, 
            { id: 'parent2', name: 'ูุงุฏุฑ', role: 'ูุงุฏุฑ', relationship: 85, respect: 75, happiness: 65, age: 38 }
          ],
          romanticRelationships: [], children: [], illnesses: [], assets: [], investments: [], log: [],
        };
        updateUI();
        window.showPage('start-screen');
        showMessageModal('ุจุงุฒ ุฑุณุช ุดุฏ!');
      }
    }

    // Filter Log (ููุชุฑ ุชุงุฑุฎฺู)
    function filterLog(type) {
      const logElement = document.getElementById('life-log-full'); // This is the UL
      const scrollContainer = document.getElementById('full-log-scroll-area'); // This is the new scroll container

      const filteredLogs = type === 'all' ? gameState.log : gameState.log.filter(log => log.type === type);
      
      logElement.innerHTML = filteredLogs.map(log => `
        <li class="glass-card p-4">
          <span class="font-semibold">ุณู ${log.year - 2025}</span>
          <p>${log.event}</p>
        </li>
      `).join('');

      // Auto-scroll to the bottom of the correct container (ุงุณฺฉุฑูู ุฎูุฏฺฉุงุฑ ุจู ูพุงู ฺฉุงูุชูุฑ ุตุญุญ)
      if (scrollContainer) {
        scrollContainer.scrollTop = scrollContainer.scrollHeight;
      }

      // Update button styles (ุจูโุฑูุฒุฑุณุงู ุงุณุชุงู ุฏฺฉููโูุง)
      document.querySelectorAll('#log-page .btn-primary').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      });
      document.getElementById(`log-filter-${type}`).classList.remove('btn-secondary');
      document.getElementById(`log-filter-${type}`).classList.add('btn-primary');
    }

    // Function to update the life log on the dashboard (ุชุงุจุน ุจุฑุง ุจูโุฑูุฒุฑุณุงู ฺฏุฒุงุฑุด ุฒูุฏฺฏ ุฏุฑ ุฏุงุดุจูุฑุฏ)
    function updateLifeLogOnDashboard() {
      const logElement = document.getElementById('life-log'); // This is the DIV containing log entries
      // Corrected: Target the actual scrollable element for the dashboard life log
      const mainDashboardContent = document.getElementById('main-dashboard-content'); 

      if (!logElement || !mainDashboardContent) return;

      // Group logs by year (ฺฏุฑููโุจูุฏ ฺฏุฒุงุฑุดโูุง ุจุฑ ุงุณุงุณ ุณุงู)
      // Iterate in reverse to group, so when rendered, years are in descending order (ูพูุงุด ุจุฑุนฺฉุณ ุจุฑุง ฺฏุฑููโุจูุฏุ ุจูุงุจุฑุงู ููฺฏุงู ุฑูุฏุฑ ุดุฏูุ ุณุงูโูุง ุจู ุชุฑุชุจ ูุฒูู ูุฑุงุฑ ูโฺฏุฑูุฏ)
      // This ensures newer years appear at the top of the generated HTML for visual hierarchy, but the scroll then moves to the latest *event* (ฺฏุฑููโุจูุฏ ุจุฑุนฺฉุณ ุชุถูู ูโฺฉูุฏ ฺฉู ุณุงูโูุง ุฌุฏุฏุชุฑ ุฏุฑ ุจุงูุง HTML ุชููุฏ ุดุฏู ุจุฑุง ุณูุณูู ูุฑุงุชุจ ุจุตุฑ ุธุงูุฑ ุดููุฏุ ุงูุง ุงุณฺฉุฑูู ุณูพุณ ุจู ุขุฎุฑู ุฑูุฏุงุฏ ูโุฑูุฏ.)
      const logsByYear = {};
      [...gameState.log].reverse().forEach(log => {
        if (!logsByYear[log.year]) {
          logsByYear[log.year] = [];
        }
        logsByYear[log.year].push(log.event);
      });

      let logHtml = '';
      const initialYear = 2025; // Assuming the game starts in 2025 (ูุฑุถ ุจุฑ ุงู ุงุณุช ฺฉู ุจุงุฒ ุฏุฑ ุณุงู ฒฐฒต ุดุฑูุน ูโุดูุฏ)

      for (const year in logsByYear) {
        if (logsByYear.hasOwnProperty(year)) {
          const currentAgeAtYearStart = parseInt(year) - initialYear; // Calculate age for the given year (ูุญุงุณุจู ุณู ุจุฑุง ุณุงู ูุดุฎุต)
          logHtml += `
            <div class="glass-card p-4 mb-4">
              <h4 class="text-lg font-semibold mb-2">ุณู ${currentAgeAtYearStart}</h4>
              <ul class="list-disc list-inside space-y-1 text-sm">
                ${logsByYear[year].map(event => `<li>${event}</li>`).join('')}\
              </ul>
            </div>
          `;
        }
      }
      logElement.innerHTML = logHtml || '<p>ุชุงุฑุฎฺู ุฒูุฏฺฏ ุดูุง ุงูุฌุง ููุงุด ุฏุงุฏู ุฎูุงูุฏ ุดุฏ.</p>';

      // Auto-scroll to the bottom of the CORRECT scroll container
      // ุงู ุฎุท ฺฉุฏ ูุณุฆูู ุงุณฺฉุฑูู ุฎูุฏฺฉุงุฑ ุจู ูพุงู ุฏุฑ ุจุฎุด ฺฏุฒุงุฑุด ุฒูุฏฺฏ ุฏุฑ ุฏุงุดุจูุฑุฏ ุงุณุช.
      // ุงู ุชุถูู ูโฺฉูุฏ ฺฉู ุฌุฏุฏุชุฑู ุฑูุฏุงุฏูุง (ฺฉู ุฏุฑ ูพุงู ูุญุชูุง ูุณุชูุฏ) ููุดู ุฏุฑ ุฏุฏ ุจุงุดูุฏ.
      mainDashboardContent.scrollTop = mainDashboardContent.scrollHeight;
    }

    // Initial setup when the window loads (ุชูุธู ุงููู ููฺฏุงู ุจุงุฑฺฏุฐุงุฑ ูพูุฌุฑู)
    window.onload = initGame;
  </script>
</body>
</html>
